<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan PPSU - Firebase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase Configuration (Demo - Replace with your actual config)
        const firebaseConfig = {
            apiKey: "demo-api-key",
            authDomain: "ppsu-pisangan-baru.firebaseapp.com",
            databaseURL: "https://ppsu-pisangan-baru-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "ppsu-pisangan-baru",
            storageBucket: "ppsu-pisangan-baru.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:demo-app-id"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDB = database;
        window.firebaseStorage = storage;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            ref, push, set, onValue, remove, update,
            storageRef, uploadBytes, getDownloadURL, deleteObject,
            signInAnonymously, onAuthStateChanged
        };

        // Initialize authentication
        signInAnonymously(auth).then(() => {
            console.log('Firebase authenticated successfully');
            window.initializeApp();
        }).catch((error) => {
            console.error('Firebase authentication failed:', error);
            // For demo purposes, continue without Firebase
            window.initializeApp();
        });
    </script>

    <style>
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in-left { animation: slideInLeft 0.6s ease-out; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
        
        .slide-in-right { animation: slideInRight 0.6s ease-out; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .connection-status {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .connection-online {
            background: rgba(34, 197, 94, 0.85);
            color: white;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }
        
        .connection-offline {
            background: rgba(239, 68, 68, 0.85);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .firebase-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .sync-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }

        .sync-online { background: #10b981; }
        .sync-offline { background: #ef4444; }
        .sync-syncing { background: #f59e0b; animation: spin 1s linear infinite; }

        @media (max-width: 768px) {
            .mobile-grid { grid-template-columns: 1fr; }
            .mobile-text { font-size: 0.875rem; }
            .mobile-padding { padding: 1rem; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 min-h-screen relative overflow-x-hidden">
    <!-- Connection Status Indicator will be in admin header -->

    <!-- Firebase Sync Indicator will be in admin header -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">Menghubungkan ke Firebase...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-effect shadow-2xl border-b border-white/20 relative z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo and Title -->
                <div class="flex items-center slide-in-left">
                    <div class="floating">
                        <i class="fas fa-clipboard-list text-white text-3xl mr-4 drop-shadow-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white drop-shadow-lg">Laporan PPSU</h1>
                        <p class="text-white/80 text-sm font-medium">Pisangan Baru</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-6 slide-in-right">
                    <button onclick="showPage('dashboard')" id="dashboardBtn" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all duration-300 font-semibold backdrop-blur-sm border border-white/20">
                        <i class="fas fa-chart-bar mr-2"></i>Dashboard
                    </button>
                    <button onclick="showPage('info')" id="infoBtn" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all duration-300 font-semibold backdrop-blur-sm border border-white/20 relative">
                        <i class="fas fa-info-circle mr-2"></i>Informasi
                        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden pulse-dot">0</span>
                    </button>
                    <button onclick="toggleNotifications()" id="notificationBtn" class="px-4 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all duration-300 font-semibold backdrop-blur-sm border border-white/20 relative">
                        <i class="fas fa-bell text-lg"></i>
                        <span id="notificationBadgeDesktop" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden pulse-dot">0</span>
                    </button>
                    <button onclick="checkAdminAccess()" id="adminBtn" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all duration-300 font-semibold backdrop-blur-sm border border-white/20">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </button>
                </div>

                <!-- Mobile Hamburger Menu -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" id="hamburgerBtn" class="p-3 bg-white/20 rounded-lg backdrop-blur-sm border border-white/30">
                        <div class="w-6 h-0.5 bg-white mb-1"></div>
                        <div class="w-6 h-0.5 bg-white mb-1"></div>
                        <div class="w-6 h-0.5 bg-white"></div>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed top-0 left-0 w-72 h-full bg-gradient-to-br from-red-600 via-purple-600 to-purple-800 z-50 transform -translate-x-full transition-transform duration-300 md:hidden shadow-2xl">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-6 border-b border-white/20">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-clipboard-list text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">Laporan PPSU</h2>
                        <p class="text-white/70 text-xs">Pisangan Baru</p>
                    </div>
                </div>
                <button onclick="toggleMobileMenu()" class="w-8 h-8 flex items-center justify-center text-white hover:bg-white/10 rounded-lg transition-all duration-300">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="flex-1 p-4 overflow-y-auto">
                <nav class="space-y-2">
                    <button onclick="showPage('dashboard'); toggleMobileMenu();" class="w-full flex items-center px-4 py-3 text-white rounded-lg hover:bg-white/10 transition-all duration-300">
                        <i class="fas fa-chart-bar mr-3"></i>Dashboard
                    </button>
                    <button onclick="showPage('info'); toggleMobileMenu();" class="w-full flex items-center px-4 py-3 text-white rounded-lg hover:bg-white/10 transition-all duration-300">
                        <i class="fas fa-info-circle mr-3"></i>Informasi
                    </button>
                    <button onclick="toggleNotifications(); toggleMobileMenu();" class="w-full flex items-center px-4 py-3 text-white rounded-lg hover:bg-white/10 transition-all duration-300">
                        <i class="fas fa-bell mr-3"></i>Notifikasi
                    </button>
                    <button onclick="checkAdminAccess(); toggleMobileMenu();" class="w-full flex items-center px-4 py-3 text-white rounded-lg hover:bg-white/10 transition-all duration-300">
                        <i class="fas fa-cog mr-3"></i>Admin Panel
                    </button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Backdrop -->
    <div id="mobileBackdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden md:hidden" onclick="toggleMobileMenu()"></div>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="fixed top-20 right-4 w-96 max-w-[90vw] bg-white rounded-2xl shadow-2xl border border-gray-200 z-[60] hidden max-h-[70vh] overflow-hidden">
        <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-t-2xl">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center">
                    <i class="fas fa-bell mr-2"></i>Notifikasi
                </h3>
                <button onclick="toggleNotifications()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        <div id="notificationList" class="overflow-y-auto max-h-96">
            <!-- Notifications will be populated here -->
        </div>
        <div id="emptyNotifications" class="p-8 text-center text-gray-500">
            <i class="fas fa-bell-slash text-4xl mb-3 text-gray-300"></i>
            <p class="text-sm">Belum ada notifikasi</p>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="max-w-7xl mx-auto mobile-padding p-6 relative z-10">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="glass-effect rounded-2xl shadow-2xl p-4 md:p-6 border-l-4 border-green-400 card-hover fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white/80">Laporan Hari Ini</p>
                        <p id="todayReports" class="text-2xl md:text-3xl font-bold text-green-400">0</p>
                    </div>
                    <div class="floating">
                        <i class="fas fa-check-circle text-green-400 text-2xl md:text-3xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-4 md:p-6 border-l-4 border-blue-400 card-hover fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white/80">Total Petugas</p>
                        <p id="totalOfficers" class="text-2xl md:text-3xl font-bold text-blue-400">43</p>
                    </div>
                    <div class="floating">
                        <i class="fas fa-users text-blue-400 text-2xl md:text-3xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-4 md:p-6 border-l-4 border-yellow-400 card-hover fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white/80">Belum Lapor</p>
                        <p id="pendingReports" class="text-2xl md:text-3xl font-bold text-yellow-400">43</p>
                    </div>
                    <div class="floating">
                        <i class="fas fa-clock text-yellow-400 text-2xl md:text-3xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-effect rounded-2xl shadow-2xl p-4 md:p-6 border-l-4 border-purple-400 card-hover fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white/80">Tingkat Kepatuhan</p>
                        <p id="complianceRate" class="text-2xl md:text-3xl font-bold text-purple-400">0%</p>
                    </div>
                    <div class="floating">
                        <i class="fas fa-chart-pie text-purple-400 text-2xl md:text-3xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Report Form -->
        <div class="glass-effect rounded-2xl shadow-2xl p-4 md:p-6 mb-8 fade-in">
            <div class="mb-6">
                <h3 class="text-xl md:text-2xl font-semibold text-white mb-2">
                    <i class="fas fa-plus-circle mr-2 text-green-400 floating"></i>Input Laporan Kerja
                </h3>
                <div class="flex items-center text-white/80">
                    <i class="fas fa-clock mr-2 text-blue-400"></i>
                    <span id="realTimeClock" class="text-sm font-medium">Loading...</span>
                </div>
            </div>
            <form id="reportForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Tim</label>
                    <input type="text" id="tim" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300" placeholder="Masukkan nama tim" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Nama Petugas Aktif</label>
                    <select id="petugasAktif" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white transition-all duration-300" required>
                        <option value="" class="bg-gray-800">Pilih Petugas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Nama Petugas Tidak Aktif</label>
                    <input type="text" id="petugasTidakAktif" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300" placeholder="Opsional">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Lokasi Area Kerja</label>
                    <input type="text" id="lokasi" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300" placeholder="Ketik nama lokasi kerja" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">
                        Verifikasi GPS 
                        <span class="text-red-400">*</span>
                        <span class="text-xs text-white/60">(Wajib untuk validasi)</span>
                    </label>
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button type="button" onclick="getCurrentLocation()" id="locationBtn" class="flex-1 px-3 py-2 bg-red-500/30 text-white rounded-lg hover:bg-red-500/50 transition-all duration-300 backdrop-blur-sm border border-red-400/30 text-sm">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span id="locationBtnText">Ambil GPS (Wajib)</span>
                            </button>
                            <button type="button" onclick="openLocationMap()" class="px-3 py-2 bg-blue-500/30 text-white rounded-lg hover:bg-blue-500/50 transition-all duration-300 backdrop-blur-sm border border-blue-400/30 text-sm">
                                <i class="fas fa-map mr-2"></i>Lihat Peta
                            </button>
                        </div>
                        <div id="locationInfo" class="hidden text-xs text-white/70 bg-white/10 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-green-400 font-semibold">
                                    <i class="fas fa-check-circle mr-1"></i>GPS Berhasil Diambil
                                </span>
                                <span class="text-white/50 text-xs">Verifikasi Lokasi</span>
                            </div>
                            <div class="grid grid-cols-1 gap-1">
                                <div class="flex items-center">
                                    <i class="fas fa-crosshairs mr-2 text-green-400"></i>
                                    <span id="coordinatesText">Koordinat: -</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-bullseye mr-2 text-blue-400"></i>
                                    <span id="accuracyText">Akurasi: -</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-2 text-purple-400"></i>
                                    <span id="locationTime">Waktu: -</span>
                                </div>
                            </div>
                        </div>
                        <div id="locationWarning" class="text-xs text-yellow-300 bg-yellow-500/20 rounded-lg p-2 border border-yellow-400/30">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <strong>Penting:</strong> Anda harus mengambil GPS untuk verifikasi lokasi sebelum mengirim laporan
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Jam Kerja</label>
                    <input type="time" id="jamKerja" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white transition-all duration-300" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Istirahat</label>
                    <input type="time" id="istirahat" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white transition-all duration-300">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-white/90 mb-2">Deskripsi Pekerjaan/Pengerjaan</label>
                    <textarea id="deskripsi" rows="3" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300 resize-none" placeholder="Deskripsikan pekerjaan yang dilakukan..." required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Foto Kerja (Live Camera)</label>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <button type="button" onclick="openCamera('user')" class="flex-1 px-4 py-2 bg-blue-500/30 text-white rounded-xl hover:bg-blue-500/50 transition-all duration-300 backdrop-blur-sm border border-blue-400/30">
                                <i class="fas fa-camera mr-2"></i>Kamera Depan
                            </button>
                            <button type="button" onclick="openCamera('environment')" class="flex-1 px-4 py-2 bg-green-500/30 text-white rounded-xl hover:bg-green-500/50 transition-all duration-300 backdrop-blur-sm border border-green-400/30">
                                <i class="fas fa-camera mr-2"></i>Kamera Belakang
                            </button>
                        </div>
                        <div id="photoPreview" class="hidden">
                            <img id="previewImage" class="max-w-full h-48 object-cover rounded-xl border-2 border-white/20">
                            <button type="button" onclick="removePhoto()" class="mt-2 px-3 py-1 bg-red-500/30 text-white rounded-lg text-sm hover:bg-red-500/50 transition-all duration-300 backdrop-blur-sm border border-red-400/30">
                                <i class="fas fa-trash mr-1"></i>Hapus Foto
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Catatan Target</label>
                    <textarea id="catatanTarget" rows="3" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300 resize-none" placeholder="Catatan tambahan"></textarea>
                </div>
                <div class="md:col-span-2">
                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-semibold text-lg shadow-2xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim Laporan
                    </button>
                </div>
            </form>
        </div>

        <!-- Recent Reports Table -->
        <div class="glass-effect rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="px-4 md:px-6 py-4 border-b border-white/20">
                <h3 class="text-lg md:text-xl font-semibold text-white">
                    <span class="pulse-dot inline-block w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                    Laporan Terbaru (Real-time)
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-white/20">
                    <thead class="glass-effect">
                        <tr>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Waktu</th>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Tim</th>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Petugas</th>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Lokasi</th>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Status</th>
                            <th class="px-4 md:px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody" class="divide-y divide-white/10">
                        <!-- Reports will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Information Page -->
    <div id="infoPage" class="max-w-7xl mx-auto mobile-padding p-6 hidden relative z-10">
        <!-- Post New Information (Admin Only) -->
        <div id="postInfoSection" class="glass-effect rounded-2xl shadow-2xl p-6 mb-8 fade-in hidden">
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-2">
                    <i class="fas fa-plus-circle mr-2 text-green-400"></i>Posting Informasi Baru
                </h3>
                <p class="text-white/70 text-sm">Bagikan jadwal, pengumuman, atau informasi penting untuk semua petugas</p>
            </div>
            <form id="infoForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-2">Jenis Informasi</label>
                        <select id="infoType" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white transition-all duration-300" required>
                            <option value="" class="bg-gray-800">Pilih Jenis</option>
                            <option value="schedule" class="bg-gray-800">📅 Jadwal Kerja</option>
                            <option value="announcement" class="bg-gray-800">📢 Pengumuman</option>
                            <option value="info" class="bg-gray-800">ℹ️ Informasi Umum</option>
                            <option value="urgent" class="bg-gray-800">🚨 Penting/Mendesak</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-2">Tanggal Berlaku</label>
                        <input type="date" id="infoDate" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white transition-all duration-300" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Judul</label>
                    <input type="text" id="infoTitle" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300" placeholder="Masukkan judul informasi..." required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-2">Isi Informasi</label>
                    <textarea id="infoContent" rows="4" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-white placeholder-white/50 transition-all duration-300 resize-none" placeholder="Tulis informasi lengkap di sini..." required></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" id="infoSubmitBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-semibold shadow-2xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2"></i>Posting
                    </button>
                    <button type="button" onclick="clearInfoForm()" class="px-6 py-3 bg-gray-500/30 text-white rounded-xl hover:bg-gray-500/50 transition-all duration-300 backdrop-blur-sm border border-gray-400/30">
                        <i class="fas fa-eraser mr-2"></i>Bersihkan
                    </button>
                </div>
            </form>
        </div>

        <!-- Information Feed -->
        <div class="space-y-6" id="infoFeed">
            <!-- Information posts will be populated here -->
        </div>

        <!-- Empty State -->
        <div id="emptyInfoState" class="glass-effect rounded-2xl shadow-2xl p-12 text-center fade-in">
            <div class="floating">
                <i class="fas fa-info-circle text-6xl text-blue-400/50 mb-4"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Belum Ada Informasi</h3>
            <p class="text-white/70">Informasi dan jadwal akan ditampilkan di sini secara real-time</p>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="max-w-7xl mx-auto mobile-padding p-6 hidden relative z-10">
        <div class="mb-6 fade-in flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white flex items-center">
                Admin Panel
                <span id="firebaseIndicator" class="firebase-indicator sync-online" title="Firebase Connected"></span>
                <div id="connectionStatus" class="connection-status connection-online">
                    <i class="fas fa-wifi text-xs"></i>
                </div>
            </h2>
            <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500/30 text-white rounded-lg hover:bg-red-500/50 transition-all duration-300 backdrop-blur-sm border border-red-400/30">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>

        <!-- Firebase Status Dashboard -->
        <div class="glass-effect rounded-2xl shadow-2xl p-6 mb-8 fade-in">
            <h3 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-database mr-2 text-purple-400"></i>Firebase Status Dashboard
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white/10 rounded-xl p-4 border border-white/20">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Database Status</p>
                            <p id="dbStatus" class="text-green-400 font-bold">Connected</p>
                        </div>
                        <i class="fas fa-database text-green-400 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 border border-white/20">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Storage Usage</p>
                            <p id="storageUsage" class="text-blue-400 font-bold">0 MB</p>
                        </div>
                        <i class="fas fa-cloud text-blue-400 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 border border-white/20">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Total Records</p>
                            <p id="totalRecords" class="text-purple-400 font-bold">0</p>
                        </div>
                        <i class="fas fa-chart-bar text-purple-400 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Controls -->
        <div class="glass-effect rounded-2xl shadow-2xl p-6 mb-8 fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h3 class="text-lg font-semibold text-white">
                    <i class="fas fa-download mr-2 text-green-400"></i>Export Data
                </h3>
                <div class="flex flex-wrap gap-3">
                    <button onclick="exportToExcel()" class="px-4 py-2 bg-green-600/30 text-green-300 rounded-lg hover:bg-green-600/50 transition-colors backdrop-blur-sm border border-green-400/30">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                    <button onclick="exportToCSV()" class="px-4 py-2 bg-blue-600/30 text-blue-300 rounded-lg hover:bg-blue-600/50 transition-colors backdrop-blur-sm border border-blue-400/30">
                        <i class="fas fa-file-csv mr-2"></i>Export CSV
                    </button>
                    <button onclick="backupData()" class="px-4 py-2 bg-purple-600/30 text-purple-300 rounded-lg hover:bg-purple-600/50 transition-colors backdrop-blur-sm border border-purple-400/30">
                        <i class="fas fa-shield-alt mr-2"></i>Backup Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Reports Management -->
        <div class="glass-effect rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="px-6 py-4 border-b border-white/20">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h3 class="text-lg font-semibold text-white">
                        <i class="fas fa-edit mr-2 text-green-400"></i>Kelola Semua Laporan (Real-time)
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="refreshData()" class="px-3 py-1 bg-blue-600/30 text-blue-300 rounded text-sm hover:bg-blue-600/50 backdrop-blur-sm border border-blue-400/30">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                        <button onclick="deleteAllReports()" class="px-3 py-1 bg-red-600/30 text-red-300 rounded text-sm hover:bg-red-600/50 backdrop-blur-sm border border-red-400/30">
                            <i class="fas fa-trash mr-1"></i>Hapus Semua
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-white/20">
                    <thead class="glass-effect">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Waktu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Tim</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Petugas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Lokasi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="adminReportsTableBody" class="divide-y divide-white/10">
                        <!-- Admin reports will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Report Detail Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Detail Laporan</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-camera mr-2 text-blue-600"></i>Ambil Foto Kerja Live
                    </h3>
                    <button onclick="closeCameraModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <video id="cameraVideo" class="w-full max-w-md mx-auto rounded-lg border-2 border-gray-300 mb-4" autoplay playsinline></video>
                    <canvas id="cameraCanvas" class="hidden"></canvas>
                    <div class="flex justify-center gap-4">
                        <button onclick="capturePhoto()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-camera mr-2"></i>Ambil Foto
                        </button>
                        <button onclick="switchCamera()" id="switchCameraBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Ganti Kamera
                        </button>
                        <button onclick="closeCameraModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-times mr-2"></i>Batal
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Foto akan diambil secara real-time dari kamera perangkat
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Map Modal -->
    <div id="locationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Lokasi Real-time Petugas</h3>
                    <button onclick="closeLocationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="mapContainer" class="w-full h-96 bg-gray-100 rounded-lg border-2 border-gray-300 relative overflow-hidden">
                    <!-- Interactive Map will be rendered here -->
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-map text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Peta Interaktif</p>
                            <p class="text-sm text-gray-500">Menampilkan lokasi petugas secara real-time</p>
                        </div>
                    </div>
                    <!-- Location markers will be added dynamically -->
                    <div id="locationMarkers" class="absolute inset-0"></div>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Lokasi Saat Ini</h4>
                        <div id="currentLocationDisplay" class="text-sm text-gray-600">
                            <p>Koordinat: <span id="currentCoords">Belum diambil</span></p>
                            <p>Akurasi: <span id="currentAccuracy">-</span></p>
                            <p>Waktu: <span id="currentTime">-</span></p>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Statistik Lokasi</h4>
                        <div class="text-sm text-gray-600">
                            <p>Total Laporan Hari Ini: <span id="todayLocationCount">0</span></p>
                            <p>Petugas Aktif: <span id="activeOfficersCount">0</span></p>
                            <p>Area Tercover: <span id="coveredAreas">0</span></p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex gap-4">
                    <button onclick="refreshLocationData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                    <button onclick="exportLocationData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Lokasi
                    </button>
                    <button onclick="closeLocationModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-times mr-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Login Admin Panel</h3>
                    <button onclick="closeLoginModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div id="loginError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <span class="text-red-800 text-sm">Username atau password salah!</span>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                        <button type="button" onclick="closeLoginModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let reports = [];
        let infoPosts = [];
        let notifications = [];
        let isAdminLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
        let currentStream = null;
        let currentFacingMode = 'environment';
        let capturedPhotoData = null;
        let isOnline = navigator.onLine;
        let firebaseConnected = false;
        let currentLocation = null;
        let locationWatchId = null;
        let locationHistory = [];

        // Officer names list
        const officers = [
            'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
            'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani',
            'Deni Arcis', 'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi',
            'Fida Marzuki Putra', 'Herdinsah', 'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien',
            'Ilham Prayitno Yudo', 'Indra Jaya', 'Irfan Mahadi', 'M. Yusuf', 'Maryanto',
            'Mohamad Irwan Yulianto', 'Muhammad Khomeini', 'Nur Iman', 'Nuryana', 'Puji Lestari',
            'Pujiyanto', 'Rafly Nugraha', 'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra',
            'Rizky Prasetia', 'Rohmah', 'Sabar Minggudi', 'Siti Marsah', 'Suhanda',
            'Supardi', 'Suwandi', 'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
        ];

        // Initialize application when Firebase is ready
        window.initializeApp = function() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            populateOfficerSelects();
            
            // Try to setup Firebase listeners
            try {
                setupFirebaseListeners();
                firebaseConnected = true;
                updateFirebaseStatus('online');
            } catch (error) {
                console.warn('Firebase not available, running in demo mode:', error);
                firebaseConnected = false;
                updateFirebaseStatus('demo');
                loadDemoData();
            }
            
            updateConnectionStatus();
            showPage('dashboard');
            startRealTimeClock();
            
            // Set default date for info form
            const today = new Date().toISOString().split('T')[0];
            const infoDateElement = document.getElementById('infoDate');
            if (infoDateElement) {
                infoDateElement.value = today;
            }

            // Setup online/offline listeners
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
            });
        };

        // Update Firebase status indicator
        function updateFirebaseStatus(status) {
            const firebaseElement = document.getElementById('firebaseIndicator');
            if (!firebaseElement) return;
            
            switch(status) {
                case 'online':
                    firebaseElement.className = 'firebase-indicator sync-online';
                    firebaseElement.title = 'Firebase Connected';
                    break;
                case 'syncing':
                    firebaseElement.className = 'firebase-indicator sync-syncing';
                    firebaseElement.title = 'Syncing to Firebase...';
                    break;
                case 'offline':
                    firebaseElement.className = 'firebase-indicator sync-offline';
                    firebaseElement.title = 'Firebase Offline';
                    break;
                case 'demo':
                    firebaseElement.className = 'firebase-indicator sync-offline';
                    firebaseElement.title = 'Demo Mode - Firebase not available';
                    break;
            }
        }

        // Load demo data when Firebase is not available
        function loadDemoData() {
            // Demo reports
            reports = [
                {
                    id: 1,
                    firebaseKey: 'demo1',
                    timestamp: new Date().toISOString(),
                    tim: 'Tim A',
                    petugasAktif: 'Achmad Rosidi',
                    petugasTidakAktif: '',
                    deskripsi: 'Pembersihan area taman',
                    lokasi: 'Taman Pisangan Baru',
                    jamKerja: '08:00',
                    istirahat: '12:00',
                    catatanTarget: 'Target selesai sore hari',
                    foto: null,
                    status: 'Aktif'
                }
            ];
            
            // Demo info posts
            infoPosts = [
                {
                    id: 1,
                    firebaseKey: 'info1',
                    timestamp: new Date().toISOString(),
                    type: 'announcement',
                    date: new Date().toISOString().split('T')[0],
                    title: 'Selamat Datang di Firebase Edition',
                    content: 'Sistem laporan PPSU kini menggunakan Firebase untuk sinkronisasi real-time. Semua data akan tersimpan di cloud dan dapat diakses dari berbagai perangkat.',
                    author: 'Admin'
                }
            ];
            
            updateDashboard();
            updateInfoFeed();
        }

        // Setup Firebase real-time listeners
        function setupFirebaseListeners() {
            if (!window.firebaseModules) return;
            
            const { ref, onValue } = window.firebaseModules;
            const database = window.firebaseDB;

            // Listen to reports
            const reportsRef = ref(database, 'reports');
            onValue(reportsRef, (snapshot) => {
                const data = snapshot.val();
                reports = data ? Object.keys(data).map(key => ({
                    firebaseKey: key,
                    ...data[key]
                })) : [];
                updateDashboard();
                updateAdminReports();
            });

            // Listen to info posts
            const infoRef = ref(database, 'infoPosts');
            onValue(infoRef, (snapshot) => {
                const data = snapshot.val();
                infoPosts = data ? Object.keys(data).map(key => ({
                    firebaseKey: key,
                    ...data[key]
                })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) : [];
                updateInfoFeed();
            });

            // Listen to notifications
            const notificationsRef = ref(database, 'notifications');
            onValue(notificationsRef, (snapshot) => {
                const data = snapshot.val();
                notifications = data ? Object.keys(data).map(key => ({
                    firebaseKey: key,
                    ...data[key]
                })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) : [];
                updateNotificationBadge();
            });
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isOnline) {
                statusElement.className = 'connection-status connection-online';
                statusElement.innerHTML = '<i class="fas fa-wifi text-xs"></i>';
                statusElement.title = 'Terhubung ke Internet';
            } else {
                statusElement.className = 'connection-status connection-offline';
                statusElement.innerHTML = '<i class="fas fa-wifi-slash text-xs"></i>';
                statusElement.title = 'Tidak ada koneksi internet';
            }
        }

        // Real-time clock function
        function startRealTimeClock() {
            function updateClock() {
                const now = new Date();
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Jakarta'
                };
                const timeString = now.toLocaleDateString('id-ID', options);
                const clockElement = document.getElementById('realTimeClock');
                if (clockElement) {
                    clockElement.textContent = timeString;
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Populate officer select dropdowns
        function populateOfficerSelects() {
            const selects = ['petugasAktif'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except the first one
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    officers.forEach(officer => {
                        const option = document.createElement('option');
                        option.value = officer;
                        option.textContent = officer;
                        option.className = 'bg-gray-800';
                        select.appendChild(option);
                    });
                }
            });
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileBackdrop = document.getElementById('mobileBackdrop');
            
            if (mobileMenu.classList.contains('-translate-x-full')) {
                mobileMenu.classList.remove('-translate-x-full');
                mobileBackdrop.classList.remove('hidden');
            } else {
                mobileMenu.classList.add('-translate-x-full');
                mobileBackdrop.classList.add('hidden');
            }
        }

        // Admin authentication functions
        function checkAdminAccess() {
            if (isAdminLoggedIn) {
                showPage('admin');
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === 'elfida' && password === 'pis212oK') {
                isAdminLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                closeLoginModal();
                showPage('admin');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        function logoutAdmin() {
            if (confirm('Apakah Anda yakin ingin logout dari Admin Panel?')) {
                isAdminLoggedIn = false;
                localStorage.removeItem('adminLoggedIn');
                showPage('dashboard');
                alert('Anda telah berhasil logout dari Admin Panel.');
            }
        }

        // Show/hide pages
        function showPage(page) {
            document.getElementById('dashboardPage').classList.toggle('hidden', page !== 'dashboard');
            document.getElementById('infoPage').classList.toggle('hidden', page !== 'info');
            document.getElementById('adminPage').classList.toggle('hidden', page !== 'admin');
            
            // Update button states
            const dashboardBtn = document.getElementById('dashboardBtn');
            const infoBtn = document.getElementById('infoBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (dashboardBtn) {
                dashboardBtn.classList.toggle('bg-blue-600', page === 'dashboard');
                dashboardBtn.classList.toggle('bg-white/20', page !== 'dashboard');
            }
            if (infoBtn) {
                infoBtn.classList.toggle('bg-purple-600', page === 'info');
                infoBtn.classList.toggle('bg-white/20', page !== 'info');
            }
            if (adminBtn) {
                adminBtn.classList.toggle('bg-green-600', page === 'admin');
                adminBtn.classList.toggle('bg-white/20', page !== 'admin');
            }
            
            if (page === 'info') {
                updateInfoFeed();
                // Show post section only for admin
                const postSection = document.getElementById('postInfoSection');
                if (postSection) {
                    postSection.classList.toggle('hidden', !isAdminLoggedIn);
                }
            }
            
            // Connection status is now part of admin header
        }

        // Handle report form submission
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate GPS location is required
            if (!currentLocation) {
                alert('⚠️ GPS Lokasi Wajib!\n\nAnda harus mengambil lokasi GPS terlebih dahulu untuk verifikasi lokasi kerja.\n\nKlik tombol "Ambil GPS (Wajib)" untuk melanjutkan.');
                return;
            }

            // Validate manual location input
            const manualLocation = document.getElementById('lokasi').value.trim();
            if (!manualLocation) {
                alert('⚠️ Nama Lokasi Wajib!\n\nSilakan ketik nama lokasi area kerja secara manual.\n\nContoh: "Jl. Pisangan Baru Raya" atau "Taman Pisangan Baru"');
                document.getElementById('lokasi').focus();
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Mengirim...';

            try {
                updateFirebaseStatus('syncing');
                
                let photoURL = null;
                
                // Upload photo if exists and Firebase is connected
                if (capturedPhotoData && firebaseConnected) {
                    photoURL = await uploadPhoto(capturedPhotoData);
                }

                // Create report object
                const report = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    tim: document.getElementById('tim').value,
                    petugasAktif: document.getElementById('petugasAktif').value,
                    petugasTidakAktif: document.getElementById('petugasTidakAktif').value,
                    deskripsi: document.getElementById('deskripsi').value,
                    lokasi: document.getElementById('lokasi').value,
                    jamKerja: document.getElementById('jamKerja').value,
                    istirahat: document.getElementById('istirahat').value,
                    catatanTarget: document.getElementById('catatanTarget').value,
                    foto: photoURL,
                    status: 'Aktif',
                    // Location data
                    coordinates: currentLocation ? {
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude,
                        accuracy: currentLocation.accuracy,
                        timestamp: currentLocation.timestamp
                    } : null,
                    locationAddress: currentLocation ? currentLocation.address : null
                };

                if (firebaseConnected) {
                    await saveReportToFirebase(report);
                    alert('Laporan berhasil dikirim!');
                } else {
                    // Demo mode - add to local array
                    report.firebaseKey = 'demo' + Date.now();
                    reports.unshift(report);
                    updateDashboard();
                    alert('Laporan dikirim (Demo Mode)');
                }
                
                // Reset form and photo
                document.getElementById('reportForm').reset();
                removePhoto();
                
                // Reset location state
                currentLocation = null;
                document.getElementById('locationInfo').classList.add('hidden');
                document.getElementById('locationWarning').classList.remove('hidden');
                
                // Reset location button
                const locationBtn = document.getElementById('locationBtn');
                locationBtn.classList.remove('bg-green-600/50', 'border-green-500/50');
                locationBtn.classList.add('bg-red-500/30', 'border-red-400/30');
                document.getElementById('locationBtnText').innerHTML = 'Ambil GPS (Wajib)';
                
                updateFirebaseStatus(firebaseConnected ? 'online' : 'demo');
                
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Gagal mengirim laporan. Silakan coba lagi.');
                updateFirebaseStatus('offline');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Save report to Firebase
        async function saveReportToFirebase(report) {
            if (!window.firebaseModules) throw new Error('Firebase not available');
            
            const { ref, push } = window.firebaseModules;
            const database = window.firebaseDB;
            
            const reportsRef = ref(database, 'reports');
            await push(reportsRef, report);
        }

        // Upload photo to Firebase Storage
        async function uploadPhoto(photoData) {
            if (!window.firebaseModules) throw new Error('Firebase Storage not available');
            
            const { storageRef, uploadBytes, getDownloadURL } = window.firebaseModules;
            const storage = window.firebaseStorage;
            
            // Convert base64 to blob
            const response = await fetch(photoData);
            const blob = await response.blob();
            
            // Create unique filename
            const filename = `photos/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
            const photoRef = storageRef(storage, filename);
            
            // Upload file
            await uploadBytes(photoRef, blob);
            
            // Get download URL
            const downloadURL = await getDownloadURL(photoRef);
            return downloadURL;
        }

        // Handle info form submission
        document.getElementById('infoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('infoSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Mengirim...';

            try {
                updateFirebaseStatus('syncing');
                
                const infoPost = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: document.getElementById('infoType').value,
                    date: document.getElementById('infoDate').value,
                    title: document.getElementById('infoTitle').value,
                    content: document.getElementById('infoContent').value,
                    author: 'Admin'
                };

                if (firebaseConnected) {
                    await saveInfoPostToFirebase(infoPost);
                    await createNotification(infoPost);
                    alert('Informasi berhasil diposting ke Firebase!');
                } else {
                    // Demo mode
                    infoPost.firebaseKey = 'info' + Date.now();
                    infoPosts.unshift(infoPost);
                    updateInfoFeed();
                    alert('Informasi diposting (Demo Mode - Firebase tidak tersedia)');
                }
                
                // Reset form
                document.getElementById('infoForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('infoDate').value = today;
                
                updateFirebaseStatus(firebaseConnected ? 'online' : 'demo');
                
            } catch (error) {
                console.error('Error saving info post:', error);
                alert('Gagal menyimpan informasi. Silakan coba lagi.');
                updateFirebaseStatus('offline');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Save info post to Firebase
        async function saveInfoPostToFirebase(infoPost) {
            if (!window.firebaseModules) throw new Error('Firebase not available');
            
            const { ref, push } = window.firebaseModules;
            const database = window.firebaseDB;
            
            const infoRef = ref(database, 'infoPosts');
            await push(infoRef, infoPost);
        }

        // Create notification
        async function createNotification(infoPost) {
            if (!firebaseConnected) return;
            
            const typeLabels = {
                schedule: 'Jadwal Kerja',
                announcement: 'Pengumuman',
                info: 'Informasi Umum',
                urgent: 'Penting/Mendesak'
            };

            const typeIcons = {
                schedule: 'fa-calendar',
                announcement: 'fa-bullhorn',
                info: 'fa-info-circle',
                urgent: 'fa-exclamation-triangle'
            };

            const notification = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: infoPost.type,
                title: `${typeLabels[infoPost.type]} Baru`,
                message: infoPost.title,
                icon: typeIcons[infoPost.type],
                postId: infoPost.id,
                read: false
            };

            const { ref, push } = window.firebaseModules;
            const database = window.firebaseDB;
            
            const notificationsRef = ref(database, 'notifications');
            await push(notificationsRef, notification);
            
            // Show browser notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`${typeLabels[infoPost.type]} Baru`, {
                    body: infoPost.title,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
                    tag: 'ppsu-info'
                });
            }
        }

        // Toggle notification panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                updateNotificationList();
                
                // Request notification permission if not granted
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badges = ['notificationBadge', 'notificationBadgeDesktop'];
            
            badges.forEach(badgeId => {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        // Update notification list
        function updateNotificationList() {
            const notificationList = document.getElementById('notificationList');
            const emptyState = document.getElementById('emptyNotifications');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            notificationList.innerHTML = '';
            
            notifications.slice(0, 20).forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `p-4 border-b border-gray-100 hover:bg-gray-50 transition-all duration-300 cursor-pointer ${!notification.read ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`;
                
                const typeColors = {
                    schedule: 'text-blue-500',
                    announcement: 'text-yellow-500',
                    info: 'text-green-500',
                    urgent: 'text-red-500'
                };
                
                notificationElement.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas ${notification.icon} ${typeColors[notification.type]} text-xs"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-sm font-semibold text-gray-800 leading-tight">${notification.title}</h4>
                                    <p class="text-sm text-gray-600 mt-0.5 leading-tight break-words">${notification.message}</p>
                                </div>
                                ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0 mt-1"></div>' : ''}
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${new Date(notification.timestamp).toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                `;
                
                notificationElement.onclick = () => {
                    if (firebaseConnected && notification.firebaseKey) {
                        markNotificationAsRead(notification.firebaseKey);
                    }
                    showPage('info');
                    toggleNotifications();
                };
                
                notificationList.appendChild(notificationElement);
            });
        }

        // Mark notification as read
        async function markNotificationAsRead(firebaseKey) {
            if (!firebaseConnected) return;
            
            try {
                const { ref, update } = window.firebaseModules;
                const database = window.firebaseDB;
                
                const notificationRef = ref(database, `notifications/${firebaseKey}`);
                await update(notificationRef, { read: true });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Clear info form
        function clearInfoForm() {
            document.getElementById('infoForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('infoDate').value = today;
        }

        // Update info feed
        function updateInfoFeed() {
            const infoFeed = document.getElementById('infoFeed');
            const emptyState = document.getElementById('emptyInfoState');
            
            if (infoPosts.length === 0) {
                infoFeed.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            infoFeed.innerHTML = '';
            
            infoPosts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = `glass-effect rounded-2xl shadow-2xl p-6 fade-in border-l-4`;
                postElement.style.animationDelay = `${index * 0.1}s`;
                
                // Add border color based on type
                const borderColors = {
                    schedule: 'border-l-blue-400',
                    announcement: 'border-l-yellow-400',
                    info: 'border-l-green-400',
                    urgent: 'border-l-red-400'
                };
                postElement.classList.add(borderColors[post.type]);
                
                const typeIcons = {
                    schedule: '📅',
                    announcement: '📢',
                    info: 'ℹ️',
                    urgent: '🚨'
                };
                
                const typeLabels = {
                    schedule: 'Jadwal Kerja',
                    announcement: 'Pengumuman',
                    info: 'Informasi Umum',
                    urgent: 'Penting/Mendesak'
                };
                
                const typeColors = {
                    schedule: 'text-blue-400',
                    announcement: 'text-yellow-400',
                    info: 'text-green-400',
                    urgent: 'text-red-400'
                };
                
                postElement.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl flex-shrink-0">
                                ${typeIcons[post.type]}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xl font-bold text-white mb-2">${post.title}</h3>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-white/70">
                                    <span class="flex items-center">
                                        <i class="fas fa-tag mr-1 ${typeColors[post.type]}"></i>
                                        ${typeLabels[post.type]}
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fas fa-calendar mr-1 text-blue-400"></i>
                                        ${new Date(post.date).toLocaleDateString('id-ID')}
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fas fa-user mr-1 text-purple-400"></i>
                                        ${post.author}
                                    </span>
                                    ${firebaseConnected ? '<span class="flex items-center"><i class="fas fa-cloud mr-1 text-green-400"></i>Firebase</span>' : '<span class="flex items-center"><i class="fas fa-desktop mr-1 text-gray-400"></i>Demo</span>'}
                                </div>
                            </div>
                        </div>
                        ${isAdminLoggedIn && firebaseConnected ? `
                            <div class="flex space-x-2 flex-shrink-0 ml-4">
                                <button onclick="deleteInfoPost('${post.firebaseKey}')" class="p-3 bg-red-500/30 text-red-300 rounded-lg hover:bg-red-500/50 transition-all duration-300 border border-red-400/30" title="Hapus Informasi">
                                    <i class="fas fa-trash text-base"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="text-white/90 leading-relaxed whitespace-pre-wrap">${post.content}</div>
                    <div class="mt-4 pt-4 border-t border-white/20 text-xs text-white/60">
                        <i class="fas fa-clock mr-1"></i>
                        Diposting ${new Date(post.timestamp).toLocaleString('id-ID')}
                    </div>
                `;
                
                infoFeed.appendChild(postElement);
            });
        }

        // Delete info post
        async function deleteInfoPost(firebaseKey) {
            if (confirm('Apakah Anda yakin ingin menghapus informasi ini?')) {
                try {
                    if (firebaseConnected) {
                        const { ref, remove } = window.firebaseModules;
                        const database = window.firebaseDB;
                        
                        const postRef = ref(database, `infoPosts/${firebaseKey}`);
                        await remove(postRef);
                        
                        alert('Informasi berhasil dihapus dari Firebase!');
                    } else {
                        // Demo mode
                        infoPosts = infoPosts.filter(p => p.firebaseKey !== firebaseKey);
                        updateInfoFeed();
                        alert('Informasi dihapus (Demo Mode)');
                    }
                } catch (error) {
                    console.error('Error deleting info post:', error);
                    alert('Gagal menghapus informasi. Silakan coba lagi.');
                }
            }
        }

        // Update dashboard statistics and table
        function updateDashboard() {
            const today = new Date().toDateString();
            const todayReports = reports.filter(r => new Date(r.timestamp).toDateString() === today);
            const reportedOfficers = new Set(todayReports.map(r => r.petugasAktif));
            const pendingCount = officers.length - reportedOfficers.size;
            const complianceRate = Math.round((reportedOfficers.size / officers.length) * 100);

            // Update dashboard stats
            const todayReportsElement = document.getElementById('todayReports');
            const pendingReportsElement = document.getElementById('pendingReports');
            const complianceRateElement = document.getElementById('complianceRate');
            
            if (todayReportsElement) todayReportsElement.textContent = todayReports.length;
            if (pendingReportsElement) pendingReportsElement.textContent = pendingCount;
            if (complianceRateElement) complianceRateElement.textContent = complianceRate + '%';

            // Update reports table
            const tbody = document.getElementById('reportsTableBody');
            if (tbody) {
                tbody.innerHTML = '';

                reports.slice(-10).reverse().forEach(report => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in hover:bg-white/5 transition-all duration-300';
                    row.innerHTML = `
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">
                            ${new Date(report.timestamp).toLocaleString('id-ID')}
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.tim}</td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.petugasAktif}</td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.lokasi}</td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-400/20 text-green-400 border border-green-400/30">
                                ${report.status}
                            </span>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewReport('${report.firebaseKey}')" class="text-blue-400 hover:text-blue-300 transition-colors duration-300">
                                <i class="fas fa-eye mr-1"></i> Lihat
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Update admin reports table
        function updateAdminReports() {
            const tbody = document.getElementById('adminReportsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            // Update Firebase status in admin panel
            const dbStatus = document.getElementById('dbStatus');
            const storageUsage = document.getElementById('storageUsage');
            const totalRecords = document.getElementById('totalRecords');
            
            if (dbStatus) {
                dbStatus.textContent = firebaseConnected ? 'Connected' : 'Demo Mode';
                dbStatus.className = firebaseConnected ? 'text-green-400 font-bold' : 'text-yellow-400 font-bold';
            }
            
            if (storageUsage) {
                const dataSize = JSON.stringify(reports).length + JSON.stringify(infoPosts).length;
                const sizeInKB = Math.round(dataSize / 1024);
                storageUsage.textContent = sizeInKB < 1024 ? `${sizeInKB} KB` : `${(sizeInKB / 1024).toFixed(2)} MB`;
            }
            
            if (totalRecords) {
                totalRecords.textContent = reports.length + infoPosts.length;
            }

            reports.slice().reverse().forEach(report => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition-all duration-300';
                row.innerHTML = `
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">
                        ${new Date(report.timestamp).toLocaleString('id-ID')}
                    </td>
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.tim}</td>
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.petugasAktif}</td>
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-white/90">${report.lokasi}</td>
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-400/20 text-green-400 border border-green-400/30">
                            ${report.status}
                        </span>
                    </td>
                    <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewReport('${report.firebaseKey}')" class="text-blue-400 hover:text-blue-300 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${firebaseConnected ? `<button onclick="deleteReport('${report.firebaseKey}')" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // View report details
        function viewReport(firebaseKey) {
            const report = reports.find(r => r.firebaseKey === firebaseKey);
            if (!report) return;

            const modal = document.getElementById('reportModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Informasi Dasar</h4>
                        <div class="space-y-3">
                            <div><span class="font-medium">Tim:</span> ${report.tim}</div>
                            <div><span class="font-medium">Petugas Aktif:</span> ${report.petugasAktif}</div>
                            <div><span class="font-medium">Petugas Tidak Aktif:</span> ${report.petugasTidakAktif || '-'}</div>
                            <div><span class="font-medium">Lokasi:</span> ${report.lokasi}</div>
                            <div><span class="font-medium">Jam Kerja:</span> ${report.jamKerja}</div>
                            <div><span class="font-medium">Istirahat:</span> ${report.istirahat || '-'}</div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Detail Pekerjaan</h4>
                        <div class="space-y-3">
                            <div><span class="font-medium">Deskripsi:</span><br>${report.deskripsi}</div>
                            <div><span class="font-medium">Catatan Target:</span><br>${report.catatanTarget || '-'}</div>
                            <div><span class="font-medium">Status:</span> 
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm">${report.status}</span>
                            </div>
                            <div><span class="font-medium">Sumber:</span> 
                                <span class="px-2 py-1 ${firebaseConnected ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'} rounded-full text-sm">
                                    ${firebaseConnected ? 'Firebase' : 'Demo Mode'}
                                </span>
                            </div>
                            ${report.coordinates ? `
                                <div><span class="font-medium">Koordinat GPS:</span><br>
                                    <span class="text-sm text-gray-600">
                                        ${report.coordinates.latitude.toFixed(6)}, ${report.coordinates.longitude.toFixed(6)}<br>
                                        Akurasi: ±${Math.round(report.coordinates.accuracy)}m<br>
                                        Waktu GPS: ${new Date(report.coordinates.timestamp).toLocaleString('id-ID')}
                                    </span>
                                </div>
                            ` : '<div><span class="font-medium">Koordinat GPS:</span> Tidak tersedia</div>'}
                        </div>
                    </div>
                    ${report.foto ? `
                        <div class="md:col-span-2">
                            <h4 class="font-semibold text-gray-800 mb-2">Foto Kerja (Live Camera)</h4>
                            <img src="${report.foto}" alt="Foto Kerja" class="max-w-full h-auto rounded-lg shadow-lg">
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Delete report
        async function deleteReport(firebaseKey) {
            if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                try {
                    if (firebaseConnected) {
                        const { ref, remove } = window.firebaseModules;
                        const database = window.firebaseDB;
                        
                        const reportRef = ref(database, `reports/${firebaseKey}`);
                        await remove(reportRef);
                        
                        alert('Laporan berhasil dihapus dari Firebase!');
                    } else {
                        // Demo mode
                        reports = reports.filter(r => r.firebaseKey !== firebaseKey);
                        updateDashboard();
                        updateAdminReports();
                        alert('Laporan dihapus (Demo Mode)');
                    }
                } catch (error) {
                    console.error('Error deleting report:', error);
                    alert('Gagal menghapus laporan. Silakan coba lagi.');
                }
            }
        }

        // Close modals
        function closeModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        // Camera functions
        function openCamera(facingMode) {
            currentFacingMode = facingMode;
            document.getElementById('cameraModal').classList.remove('hidden');
            startCamera();
        }

        function closeCameraModal() {
            document.getElementById('cameraModal').classList.add('hidden');
            stopCamera();
        }

        async function startCamera() {
            try {
                const video = document.getElementById('cameraVideo');
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan.');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            stopCamera();
            startCamera();
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show preview
            document.getElementById('previewImage').src = capturedPhotoData;
            document.getElementById('photoPreview').classList.remove('hidden');
            
            closeCameraModal();
        }

        function removePhoto() {
            capturedPhotoData = null;
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('previewImage').src = '';
        }

        // Export functions
        function exportToExcel() {
            if (reports.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(reports.map(report => ({
                'Waktu': new Date(report.timestamp).toLocaleString('id-ID'),
                'Tim': report.tim,
                'Petugas Aktif': report.petugasAktif,
                'Petugas Tidak Aktif': report.petugasTidakAktif,
                'Lokasi': report.lokasi,
                'Jam Kerja': report.jamKerja,
                'Istirahat': report.istirahat,
                'Deskripsi': report.deskripsi,
                'Catatan Target': report.catatanTarget,
                'Status': report.status,
                'Sumber': firebaseConnected ? 'Firebase' : 'Demo'
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan PPSU');
            
            const fileName = `Laporan_PPSU_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportToCSV() {
            if (reports.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }

            const csvContent = [
                ['Waktu', 'Tim', 'Petugas Aktif', 'Petugas Tidak Aktif', 'Lokasi', 'Jam Kerja', 'Istirahat', 'Deskripsi', 'Catatan Target', 'Status', 'Sumber'],
                ...reports.map(report => [
                    new Date(report.timestamp).toLocaleString('id-ID'),
                    report.tim,
                    report.petugasAktif,
                    report.petugasTidakAktif,
                    report.lokasi,
                    report.jamKerja,
                    report.istirahat,
                    report.deskripsi,
                    report.catatanTarget,
                    report.status,
                    firebaseConnected ? 'Firebase' : 'Demo'
                ])
            ].map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Laporan_PPSU_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function backupData() {
            const backupData = {
                reports: reports,
                infoPosts: infoPosts,
                notifications: notifications,
                timestamp: new Date().toISOString(),
                source: firebaseConnected ? 'Firebase' : 'Demo'
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Backup_PPSU_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshData() {
            if (firebaseConnected) {
                alert('Data Firebase akan diperbarui secara otomatis (real-time)');
            } else {
                alert('Dalam mode demo - data sudah terbaru');
            }
        }

        function deleteAllReports() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA laporan? Tindakan ini tidak dapat dibatalkan!')) {
                if (firebaseConnected) {
                    // In a real implementation, you would delete from Firebase
                    alert('Fitur hapus semua data Firebase memerlukan konfirmasi tambahan untuk keamanan.');
                } else {
                    reports = [];
                    updateDashboard();
                    updateAdminReports();
                    alert('Semua laporan demo telah dihapus');
                }
            }
        }

        // Location tracking functions
        function getCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const originalText = locationBtn.innerHTML;
            
            if (!navigator.geolocation) {
                alert('Geolocation tidak didukung oleh browser ini.');
                return;
            }

            locationBtn.disabled = true;
            locationBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Mengambil lokasi...';

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const coords = position.coords;
                    currentLocation = {
                        latitude: coords.latitude,
                        longitude: coords.longitude,
                        accuracy: coords.accuracy,
                        timestamp: new Date().toISOString()
                    };

                    // Try to get address from coordinates
                    try {
                        const address = await reverseGeocode(coords.latitude, coords.longitude);
                        currentLocation.address = address;
                    } catch (error) {
                        console.warn('Could not get address:', error);
                        currentLocation.address = `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
                    }

                    // Don't auto-fill the location input - keep it manual
                    // User must type the location name manually

                    // Show location info with GPS verification
                    document.getElementById('locationInfo').classList.remove('hidden');
                    document.getElementById('locationWarning').classList.add('hidden');
                    document.getElementById('coordinatesText').textContent = 
                        `Koordinat: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
                    document.getElementById('accuracyText').textContent = 
                        `Akurasi: ±${Math.round(coords.accuracy)}m`;
                    document.getElementById('locationTime').textContent = 
                        `Waktu: ${new Date().toLocaleString('id-ID')}`;

                    // Add to location history
                    locationHistory.push({
                        ...currentLocation,
                        officer: document.getElementById('petugasAktif').value || 'Unknown',
                        team: document.getElementById('tim').value || 'Unknown'
                    });

                    // Update button to show success
                    locationBtn.disabled = false;
                    locationBtn.classList.remove('bg-red-500/30', 'border-red-400/30');
                    locationBtn.classList.add('bg-green-600/50', 'border-green-500/50');
                    document.getElementById('locationBtnText').innerHTML = '<i class="fas fa-check mr-1"></i>GPS Tersimpan';

                    // Keep the success state permanently
                    // Don't revert back to original state
                },
                (error) => {
                    let errorMessage = 'Gagal mengambil lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Izin lokasi ditolak. Silakan aktifkan GPS dan berikan izin lokasi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Timeout. Coba lagi.';
                            break;
                        default:
                            errorMessage += 'Error tidak dikenal.';
                            break;
                    }
                    alert(errorMessage);
                    
                    locationBtn.disabled = false;
                    locationBtn.innerHTML = originalText;
                },
                options
            );
        }

        // Simple reverse geocoding using a free service
        async function reverseGeocode(lat, lng) {
            try {
                // Using OpenStreetMap Nominatim (free service)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.display_name) {
                    return data.display_name;
                } else {
                    return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            } catch (error) {
                console.warn('Reverse geocoding failed:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Open location map modal
        function openLocationMap() {
            document.getElementById('locationModal').classList.remove('hidden');
            updateLocationMap();
            updateLocationStats();
        }

        // Close location map modal
        function closeLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        // Update location map with markers
        function updateLocationMap() {
            const markersContainer = document.getElementById('locationMarkers');
            markersContainer.innerHTML = '';

            // Get today's reports with location data
            const today = new Date().toDateString();
            const todayReportsWithLocation = reports.filter(r => 
                new Date(r.timestamp).toDateString() === today && r.coordinates
            );

            // Create markers for each location
            todayReportsWithLocation.forEach((report, index) => {
                const marker = document.createElement('div');
                marker.className = 'absolute w-6 h-6 bg-red-500 rounded-full border-2 border-white shadow-lg cursor-pointer transform -translate-x-1/2 -translate-y-1/2 hover:scale-110 transition-transform';
                marker.style.left = `${20 + (index % 10) * 8}%`;
                marker.style.top = `${20 + Math.floor(index / 10) * 15}%`;
                marker.title = `${report.petugasAktif} - ${report.lokasi}`;
                
                // Add click handler to show report details
                marker.onclick = () => {
                    alert(`Petugas: ${report.petugasAktif}\nLokasi: ${report.lokasi}\nWaktu: ${new Date(report.timestamp).toLocaleString('id-ID')}\nKoordinat: ${report.coordinates.latitude.toFixed(6)}, ${report.coordinates.longitude.toFixed(6)}`);
                };

                markersContainer.appendChild(marker);
            });

            // Add current location marker if available
            if (currentLocation) {
                const currentMarker = document.createElement('div');
                currentMarker.className = 'absolute w-8 h-8 bg-blue-500 rounded-full border-3 border-white shadow-lg animate-pulse';
                currentMarker.style.left = '50%';
                currentMarker.style.top = '50%';
                currentMarker.style.transform = 'translate(-50%, -50%)';
                currentMarker.title = 'Lokasi Anda Saat Ini';
                
                markersContainer.appendChild(currentMarker);

                // Update current location display
                document.getElementById('currentCoords').textContent = 
                    `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
                document.getElementById('currentAccuracy').textContent = 
                    `±${Math.round(currentLocation.accuracy)}m`;
                document.getElementById('currentTime').textContent = 
                    new Date(currentLocation.timestamp).toLocaleString('id-ID');
            }
        }

        // Update location statistics
        function updateLocationStats() {
            const today = new Date().toDateString();
            const todayReportsWithLocation = reports.filter(r => 
                new Date(r.timestamp).toDateString() === today && r.coordinates
            );
            
            const activeOfficers = new Set(todayReportsWithLocation.map(r => r.petugasAktif));
            const coveredAreas = new Set(todayReportsWithLocation.map(r => r.lokasi));

            document.getElementById('todayLocationCount').textContent = todayReportsWithLocation.length;
            document.getElementById('activeOfficersCount').textContent = activeOfficers.size;
            document.getElementById('coveredAreas').textContent = coveredAreas.size;
        }

        // Refresh location data
        function refreshLocationData() {
            updateLocationMap();
            updateLocationStats();
            alert('Data lokasi telah diperbarui!');
        }

        // Export location data
        function exportLocationData() {
            const today = new Date().toDateString();
            const locationData = reports.filter(r => 
                new Date(r.timestamp).toDateString() === today && r.coordinates
            ).map(report => ({
                'Waktu': new Date(report.timestamp).toLocaleString('id-ID'),
                'Petugas': report.petugasAktif,
                'Tim': report.tim,
                'Lokasi': report.lokasi,
                'Latitude': report.coordinates.latitude,
                'Longitude': report.coordinates.longitude,
                'Akurasi (m)': Math.round(report.coordinates.accuracy),
                'Alamat': report.locationAddress || '-'
            }));

            if (locationData.length === 0) {
                alert('Tidak ada data lokasi untuk diekspor hari ini');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(locationData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Lokasi Petugas');
            
            const fileName = `Lokasi_Petugas_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9737b3517769ef6a',t:'MTc1NTkyMTYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
