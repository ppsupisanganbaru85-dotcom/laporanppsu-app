<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSU-Pisbar-App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places&callback=initGoogleMaps"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, orderBy, query, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';
        
        // KONFIGURASI FIREBASE - TERHUBUNG KE PROYEK ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyDhtb3vYVPopaNHyhUlHaxsFhA6_gbyDvg",
            authDomain: "aplikasi-laporan-ppsu.firebaseapp.com",
            databaseURL: "https://aplikasi-laporan-ppsu-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aplikasi-laporan-ppsu",
            storageBucket: "aplikasi-laporan-ppsu.firebasestorage.app",
            messagingSenderId: "990462370722",
            appId: "1:990462370722:web:4ab77301f1decdfc1c88fb",
            measurementId: "G-7T6X3MMYEH"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.storage = getStorage(window.firebaseApp);
        
        // Export Firebase functions to global scope
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.query = query;
        window.serverTimestamp = serverTimestamp;
        window.updateDoc = updateDoc;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            animation: gradientShift 8s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            50% { background: linear-gradient(135deg, #764ba2 0%, #f093fb 50%, #667eea 100%); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .hamburger {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 4px;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
            z-index: 1000;
            padding-top: 80px;
        }
        
        .mobile-menu.active {
            left: 0;
        }
        
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #000;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        .capture-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid #ccc;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .capture-btn:hover {
            transform: scale(1.1);
        }
        
        .post-animation {
            animation: postSlideIn 0.5s ease-out;
        }
        
        @keyframes postSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .location-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
        }
        
        .location-status.loading {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .location-status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }
        
        .location-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .camera-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .photo-preview-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .photo-preview-image {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .google-map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .map-container {
            position: relative;
            margin: 10px 0;
        }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .location-accuracy {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="px-6 py-4">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-lg">P</span>
                </div>
                <h1 class="text-white text-lg font-bold">PPSU-Pisbar-App</h1>
            </div>
            <nav class="space-y-2">
                <button onclick="showPage('home'); toggleMobileMenu();" class="w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>🏠</span>
                    <span>Beranda</span>
                </button>
                <button onclick="showPage('reports'); toggleMobileMenu();" class="w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>📝</span>
                    <span>Laporan</span>
                </button>
                <button onclick="showPage('feed'); toggleMobileMenu();" class="w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>💬</span>
                    <span>Feed</span>
                </button>
                <button onclick="showPage('admin'); toggleMobileMenu();" class="w-full text-left text-white hover:bg-white/10 px-4 py-3 rounded-lg transition-colors flex items-center space-x-3">
                    <span>⚙️</span>
                    <span>Admin</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm">
        <span id="notificationText">Berhasil!</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">P</span>
                    </div>
                    <h1 class="text-white text-lg font-bold">PPSU-Pisbar-App</h1>
                </div>
                
                <!-- Hamburger Menu -->
                <div class="hamburger" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="homePage" class="page fade-in">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold text-white mb-3">Selamat Datang di PPSU-Pisbar-App</h2>
                <p class="text-white/80 text-sm md:text-base">Sistem Pelaporan Kerja Digital untuk Tim PPSU</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 md:gap-6 max-w-5xl mx-auto">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">📝</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Input Laporan</h3>
                        <p class="text-white/70 mb-3 text-sm">Buat laporan kerja harian dengan mudah</p>
                        <button onclick="showPage('reports')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Mulai Laporan
                        </button>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">💬</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Feed Aktivitas</h3>
                        <p class="text-white/70 mb-3 text-sm">Lihat dan komentari aktivitas tim</p>
                        <button onclick="showPage('feed')" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Lihat Feed
                        </button>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 card-hover border border-white/20">
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white text-lg md:text-xl">⚙️</span>
                        </div>
                        <h3 class="text-white text-lg md:text-xl font-semibold mb-2">Panel Admin</h3>
                        <p class="text-white/70 mb-3 text-sm">Kelola petugas dan rekap laporan</p>
                        <button onclick="showPage('admin')" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm">
                            Masuk Admin
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reportsPage" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-6 text-center">Input Laporan Kerja</h2>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20">
                    <form id="reportForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                                <input type="text" id="team" placeholder="Masukkan nama tim" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Shift Jam Kerja</label>
                                <input type="text" id="shift" placeholder="Masukkan shift jam kerja" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Nama Petugas Aktif</label>
                                <input type="text" id="activeOfficers" placeholder="Masukkan nama petugas aktif" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Nama Petugas Tidak Aktif <span class="text-white/50">(Opsional)</span></label>
                                <input type="text" id="inactiveOfficers" placeholder="Masukkan nama petugas tidak aktif (jika ada)" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Lokasi Kerja</label>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="location" placeholder="Klik 'Ambil Lokasi' atau ketik manual" class="flex-1 px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <button type="button" id="locationBtn" onclick="getLocationWithGoogleMaps()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm whitespace-nowrap">
                                    🗺️ Ambil Lokasi
                                </button>
                                <button type="button" id="showMapBtn" onclick="toggleLocationMap()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm whitespace-nowrap">
                                    📍 Lihat Peta
                                </button>
                            </div>
                            <div id="locationStatus" class="location-status hidden">
                                <span id="locationStatusText">Mengambil lokasi...</span>
                            </div>
                            
                            <!-- Google Maps Container -->
                            <div id="locationMapContainer" class="map-container hidden">
                                <div class="map-overlay">
                                    <span>🗺️ Google Maps</span>
                                    <span id="mapAccuracy" class="location-accuracy">GPS Aktif</span>
                                </div>
                                <div id="locationMap" class="google-map"></div>
                                <div class="flex gap-2 mt-2">
                                    <button type="button" onclick="confirmMapLocation()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">
                                        ✅ Gunakan Lokasi Ini
                                    </button>
                                    <button type="button" onclick="toggleLocationMap()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                                        ❌ Tutup Peta
                                    </button>
                                </div>
                            </div>
                            
                            <p class="text-white/50 text-xs mt-1">🗺️ <strong>Google Maps Terintegrasi:</strong> Lokasi akurat dengan peta visual dan Places API</p>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Foto Dokumentasi</label>
                            <div class="camera-container">
                                <!-- Live Camera Preview -->
                                <video id="cameraPreview" class="camera-preview hidden" autoplay playsinline muted></video>
                                
                                <!-- Camera Status Overlay -->
                                <div id="cameraStatus" class="camera-status hidden">
                                    <span id="cameraStatusText">🔴 Kamera Live</span>
                                </div>
                                
                                <!-- Camera Controls Overlay -->
                                <div id="cameraControls" class="camera-controls hidden">
                                    <button type="button" id="captureBtn" onclick="capturePhotoAdvanced()" class="capture-btn bg-white hover:bg-gray-100 transition-all">
                                        📸
                                    </button>
                                    <button type="button" id="switchCameraBtn" onclick="switchCamera()" class="capture-btn bg-blue-500 hover:bg-blue-600 text-white transition-all">
                                        🔄
                                    </button>
                                </div>
                                
                                <!-- Hidden Canvas for Processing -->
                                <canvas id="photoCanvas" class="hidden"></canvas>
                                
                                <!-- Photo Preview with Professional Layout -->
                                <div id="photoPreview" class="photo-preview-container hidden">
                                    <img id="previewImage" class="photo-preview-image">
                                    <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-lg text-xs font-medium shadow-lg">
                                        ✅ Foto Siap
                                    </div>
                                    <div class="absolute bottom-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs" id="photoInfo">
                                        📷 Resolusi: Loading...
                                    </div>
                                </div>
                                
                                <!-- Professional Camera Controls -->
                                <div class="flex flex-col gap-3 mt-3">
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <button type="button" id="startCameraBtn" onclick="startCameraAdvanced()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium">
                                            📷 Buka Kamera Live
                                        </button>
                                        <button type="button" id="retakeBtn" onclick="retakePhotoAdvanced()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium hidden">
                                            🔄 Foto Ulang
                                        </button>
                                        <button type="button" id="stopCameraBtn" onclick="stopCameraAdvanced()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm font-medium hidden">
                                            ⏹️ Tutup Kamera
                                        </button>
                                    </div>
                                    
                                    <!-- Camera Settings -->
                                    <div id="cameraSettings" class="hidden bg-white/5 rounded-lg p-3 space-y-2">
                                        <div class="flex items-center justify-between text-white text-xs">
                                            <span>Kualitas:</span>
                                            <select id="qualitySelect" onchange="changeQuality()" class="bg-white/20 text-white rounded px-2 py-1 text-xs">
                                                <option value="high">Tinggi (1920x1080)</option>
                                                <option value="medium" selected>Sedang (1280x720)</option>
                                                <option value="low">Rendah (640x480)</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center justify-between text-white text-xs">
                                            <span>Kamera:</span>
                                            <select id="cameraSelect" onchange="switchToSelectedCamera()" class="bg-white/20 text-white rounded px-2 py-1 text-xs">
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button type="button" id="toggleSettingsBtn" onclick="toggleCameraSettings()" class="text-white/70 hover:text-white text-xs transition-colors">
                                        ⚙️ Pengaturan Kamera
                                    </button>
                                </div>
                                
                                <!-- Camera Tips -->
                                <div class="mt-2 text-white/60 text-xs space-y-1">
                                    <p>💡 <strong>Tips:</strong> Pastikan pencahayaan cukup untuk hasil terbaik</p>
                                    <p>📱 Gunakan kamera belakang untuk dokumentasi lapangan</p>
                                    <p>🔄 Klik tombol biru di preview untuk ganti kamera</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Deskripsi Pengerjaan</label>
                            <textarea id="description" rows="3" placeholder="Jelaskan detail pekerjaan yang dilakukan..." class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition-all pulse-button text-sm">
                                📤 Submit Laporan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Page -->
    <div id="feedPage" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-6 text-center">Feed Aktivitas Tim</h2>
                
                <!-- Post Input Form -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20 mb-6">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="mr-2">✍️</span>
                        Buat Postingan Baru
                    </h3>
                    <form id="postForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Nama Petugas</label>
                                <input type="text" id="postAuthor" placeholder="Masukkan nama Anda" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                                <input type="text" id="postTeam" placeholder="Masukkan nama tim" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Informasi/Pengumuman</label>
                            <textarea id="postContent" rows="3" placeholder="Bagikan informasi, pengumuman, atau update kegiatan..." class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Lokasi (Opsional)</label>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="postLocation" placeholder="Masukkan lokasi atau ambil otomatis" class="flex-1 px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <button type="button" onclick="getPostLocationWithGoogleMaps()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm whitespace-nowrap">
                                    🗺️ Ambil Lokasi
                                </button>
                                <button type="button" onclick="togglePostLocationMap()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all text-sm whitespace-nowrap">
                                    📍 Lihat Peta
                                </button>
                            </div>
                            
                            <!-- Google Maps Container for Posts -->
                            <div id="postLocationMapContainer" class="map-container hidden">
                                <div class="map-overlay">
                                    <span>🗺️ Google Maps</span>
                                    <span id="postMapAccuracy" class="location-accuracy">GPS Aktif</span>
                                </div>
                                <div id="postLocationMap" class="google-map"></div>
                                <div class="flex gap-2 mt-2">
                                    <button type="button" onclick="confirmPostMapLocation()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">
                                        ✅ Gunakan Lokasi Ini
                                    </button>
                                    <button type="button" onclick="togglePostLocationMap()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                                        ❌ Tutup Peta
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition-all text-sm">
                                📢 Posting Sekarang
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="feedContainer" class="space-y-6">
                    <!-- Feed items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLoginPage" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-md mx-auto">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h2 class="text-xl font-bold text-white mb-4 text-center">Login Admin</h2>
                    
                    <form id="adminLoginForm" class="space-y-3">
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Username</label>
                            <input type="text" id="adminUsername" placeholder="Masukkan username" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-white font-medium mb-1 text-sm">Password</label>
                            <input type="password" id="adminPassword" placeholder="Masukkan password" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 rounded-lg font-semibold hover:shadow-lg transition-all text-sm">
                            🔐 Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="page hidden">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-white">Dashboard Admin</h2>
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                    🚪 Logout
                </button>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white" id="totalReports">0</div>
                        <div class="text-white/70">Total Laporan</div>
                    </div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white" id="todayReports">0</div>
                        <div class="text-white/70">Laporan Hari Ini</div>
                    </div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white" id="activeOfficersCount">0</div>
                        <div class="text-white/70">Petugas Aktif</div>
                    </div>
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-white" id="totalPosts">0</div>
                        <div class="text-white/70">Total Postingan</div>
                    </div>
                </div>
            </div>
            
            <!-- Export Buttons -->
            <div class="mb-6 flex space-x-4">
                <button onclick="exportToExcel()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                    📊 Export Excel
                </button>
                <button onclick="exportToPDF()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors">
                    📄 Export PDF
                </button>
            </div>
            
            <!-- Management Tables -->
            <div class="space-y-8">
                <!-- Reports Management Table -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h3 class="text-xl font-bold text-white mb-4">Manajemen Laporan Kerja</h3>
                    
                    <div class="mb-4 flex space-x-4">
                        <select id="filterPeriod" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                            <option value="daily">Harian</option>
                            <option value="monthly">Bulanan</option>
                        </select>
                        <input type="date" id="filterDate" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left py-3 px-4">Tanggal</th>
                                    <th class="text-left py-3 px-4">Tim</th>
                                    <th class="text-left py-3 px-4">Shift</th>
                                    <th class="text-left py-3 px-4">Petugas Aktif</th>
                                    <th class="text-left py-3 px-4">Lokasi</th>
                                    <th class="text-left py-3 px-4">Foto</th>
                                    <th class="text-left py-3 px-4">Status</th>
                                    <th class="text-left py-3 px-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Feed Posts Management Table -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h3 class="text-xl font-bold text-white mb-4">Manajemen Postingan Feed</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left py-3 px-4">Tanggal</th>
                                    <th class="text-left py-3 px-4">Penulis</th>
                                    <th class="text-left py-3 px-4">Tim</th>
                                    <th class="text-left py-3 px-4">Konten</th>
                                    <th class="text-left py-3 px-4">Tipe</th>
                                    <th class="text-left py-3 px-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="feedTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Report Modal -->
    <div id="editReportModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Edit Laporan</h3>
            
            <form id="editReportForm" class="space-y-4">
                <input type="hidden" id="editReportId">
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                        <input type="text" id="editTeam" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Shift</label>
                        <input type="text" id="editShift" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Petugas Aktif</label>
                        <input type="text" id="editActiveOfficers" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Petugas Tidak Aktif</label>
                        <input type="text" id="editInactiveOfficers" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Lokasi</label>
                    <input type="text" id="editLocation" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Deskripsi</label>
                    <textarea id="editDescription" rows="3" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" onclick="saveReportEdit()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                        💾 Simpan
                    </button>
                    <button type="button" onclick="closeEditModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                        ❌ Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Edit Postingan</h3>
            
            <form id="editPostForm" class="space-y-4">
                <input type="hidden" id="editPostId">
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Penulis</label>
                        <input type="text" id="editPostAuthor" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-white font-medium mb-1 text-sm">Tim</label>
                        <input type="text" id="editPostTeam" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Konten</label>
                    <textarea id="editPostContent" rows="3" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none text-sm"></textarea>
                </div>
                
                <div>
                    <label class="block text-white font-medium mb-1 text-sm">Lokasi</label>
                    <input type="text" id="editPostLocation" class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" onclick="savePostEdit()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                        💾 Simpan
                    </button>
                    <button type="button" onclick="closeEditPostModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                        ❌ Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let reports = [];
        let feedPosts = [];
        let cameraStream = null;
        let capturedPhoto = null;
        let reportsListener = null;
        let feedListener = null;
        let locationWatchId = null;
        let availableCameras = [];
        let currentCameraIndex = 0;
        let currentQuality = 'medium';
        
        // Google Maps variables
        let googleMapsLoaded = false;
        let locationMap = null;
        let postLocationMap = null;
        let currentLocationMarker = null;
        let postLocationMarker = null;
        let currentMapPosition = null;
        let postMapPosition = null;
        let geocoder = null;
        let placesService = null;
        
        // Initialize Google Maps
        function initGoogleMaps() {
            googleMapsLoaded = true;
            geocoder = new google.maps.Geocoder();
            console.log('🗺️ Google Maps API loaded successfully!');
            showNotification('🗺️ Google Maps siap digunakan!', 'success');
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showPage('home');
            setupEventListeners();
            
            // Test Firebase connection
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
            
            initializeFirebaseListeners();
            
            // Check camera and location permissions on load
            checkDeviceCapabilities();
        });
        
        // Check device capabilities
        async function checkDeviceCapabilities() {
            // Check camera
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log(`Found ${videoDevices.length} camera(s)`);
                    
                    if (videoDevices.length > 0) {
                        showNotification(`📷 ${videoDevices.length} kamera tersedia`, 'success');
                    }
                } catch (error) {
                    console.log('Camera check error:', error);
                }
            }
            
            // Check location
            if (navigator.geolocation) {
                console.log('Geolocation API tersedia');
                showNotification('📍 GPS tersedia', 'success');
            } else {
                showNotification('⚠️ GPS tidak tersedia di browser ini', 'info');
            }
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                const testQuery = query(collection(window.db, 'reports'));
                await getDocs(testQuery);
                
                showNotification('🎉 Firebase terhubung! Proyek: aplikasi-laporan-ppsu', 'success');
                updateConnectionStatus(true);
                
            } catch (error) {
                console.log('Firebase connection test failed:', error);
                showNotification('⚠️ Gagal terhubung Firebase. Periksa aturan Firestore.', 'error');
                updateConnectionStatus(false);
            }
        }
        
        function updateConnectionStatus(connected) {
            const nav = document.querySelector('nav .container');
            let statusIndicator = document.getElementById('firebaseStatus');
            
            if (!statusIndicator) {
                statusIndicator = document.createElement('div');
                statusIndicator.id = 'firebaseStatus';
                statusIndicator.className = 'text-xs px-2 py-1 rounded-full';
                nav.appendChild(statusIndicator);
            }
            
            if (connected) {
                statusIndicator.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300 border border-green-500/30';
                statusIndicator.innerHTML = '🟢 Firebase Connected';
            } else {
                statusIndicator.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300 border border-red-500/30';
                statusIndicator.innerHTML = '🔴 Firebase Disconnected';
            }
        }
        
        // Initialize Firebase real-time listeners
        function initializeFirebaseListeners() {
            try {
                showNotification('🔄 Menghubungkan ke Firebase "aplikasi-laporan-ppsu"...', 'info');
                
                // Listen to reports collection
                const reportsQuery = query(collection(window.db, 'reports'), orderBy('createdAt', 'desc'));
                reportsListener = onSnapshot(reportsQuery, (snapshot) => {
                    reports = [];
                    snapshot.forEach((doc) => {
                        reports.push({ id: doc.id, ...doc.data() });
                    });
                    updateAdminStats();
                    updateReportsTable();
                    
                    if (reports.length >= 0) {
                        showNotification('✅ Berhasil terhubung ke Firebase! Semua data tersimpan permanen di cloud.', 'success');
                    }
                }, (error) => {
                    console.log('Error listening to reports:', error);
                    showNotification('❌ Gagal terhubung Firebase. Periksa konfigurasi atau koneksi internet.', 'error');
                });
                
                // Listen to feed collection
                const feedQuery = query(collection(window.db, 'feed'), orderBy('createdAt', 'desc'));
                feedListener = onSnapshot(feedQuery, (snapshot) => {
                    feedPosts = [];
                    snapshot.forEach((doc) => {
                        feedPosts.push({ id: doc.id, ...doc.data() });
                    });
                    loadFeedPosts();
                    updateFeedTable();
                }, (error) => {
                    console.log('Error listening to feed:', error);
                    showNotification('❌ Gagal memuat feed dari Firebase.', 'error');
                });
                
            } catch (error) {
                console.log('Firebase initialization error:', error);
                showNotification('⚠️ Firebase belum dikonfigurasi. Data hanya tersimpan lokal.', 'info');
                
                // Fallback to localStorage
                reports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
                feedPosts = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                loadFeedPosts();
                updateFeedTable();
            }
        }
        
        function setupEventListeners() {
            // Report form submit
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitReport();
            });
            
            // Post form submit
            document.getElementById('postForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitPost();
            });
            
            // Admin login form
            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                adminLogin();
            });
            
            // Filter change
            document.getElementById('filterDate')?.addEventListener('change', updateReportsTable);
            document.getElementById('filterPeriod')?.addEventListener('change', updateReportsTable);
        }
        
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const hamburger = document.querySelector('.hamburger');
            
            mobileMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show requested page
            if (pageId === 'admin') {
                if (currentUser && currentUser.role === 'admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    updateAdminStats();
                    updateReportsTable();
                    updateFeedTable();
                } else {
                    document.getElementById('adminLoginPage').classList.remove('hidden');
                }
            } else {
                document.getElementById(pageId + 'Page').classList.remove('hidden');
            }
            
            // Add fade-in animation
            setTimeout(() => {
                document.querySelector('.page:not(.hidden)').classList.add('fade-in');
            }, 50);
        }
        
        // GOOGLE MAPS INTEGRATED LOCATION FUNCTIONS
        async function getLocationWithGoogleMaps() {
            if (!googleMapsLoaded) {
                showNotification('⏳ Google Maps sedang dimuat...', 'info');
                setTimeout(() => getLocationWithGoogleMaps(), 2000);
                return;
            }
            
            const locationInput = document.getElementById('location');
            const button = document.getElementById('locationBtn');
            const statusDiv = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');
            
            // Show loading state
            button.innerHTML = '⏳ Mengambil...';
            button.disabled = true;
            statusDiv.className = 'location-status loading';
            statusDiv.classList.remove('hidden');
            statusText.textContent = '🗺️ Mengambil lokasi dengan Google Maps...';
            
            if (!navigator.geolocation) {
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS tidak tersedia - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = '❌ GPS tidak tersedia - Input manual aktif';
                
                button.innerHTML = '🗺️ Ambil Lokasi';
                button.disabled = false;
                
                showNotification('GPS tidak tersedia. Silakan input lokasi manual.', 'info');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                statusText.textContent = `🗺️ GPS ditemukan (akurasi: ${Math.round(accuracy)}m) - Mengambil alamat Google...`;
                
                // Use Google Maps Geocoding API for better accuracy
                const address = await getAddressFromGoogleMaps(lat, lon);
                
                if (address) {
                    locationInput.value = address;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `✅ Lokasi Google Maps (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification(`🗺️ Lokasi berhasil diambil dengan Google Maps! Akurasi ${Math.round(accuracy)}m`, 'success');
                    
                    // Store position for map display
                    currentMapPosition = { lat, lng: lon, accuracy };
                } else {
                    // Fallback to coordinates
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `✅ Koordinat GPS (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                    
                    currentMapPosition = { lat, lng: lon, accuracy };
                }
                
            } catch (error) {
                console.error('Google Maps location error:', error);
                
                let errorMessage = 'GPS tidak dapat diakses';
                if (error.code === 1) {
                    errorMessage = 'Izin GPS ditolak - Aktifkan di pengaturan browser';
                } else if (error.code === 2) {
                    errorMessage = 'Posisi tidak tersedia - Coba di area terbuka';
                } else if (error.code === 3) {
                    errorMessage = 'Timeout GPS - Sinyal lemah';
                }
                
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS gagal - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = `❌ ${errorMessage}`;
                
                showNotification(`${errorMessage}. Input manual diaktifkan.`, 'info');
            }
            
            button.innerHTML = '🗺️ Ambil Lokasi';
            button.disabled = false;
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Get address using Google Maps Geocoding API
        async function getAddressFromGoogleMaps(lat, lng) {
            if (!geocoder) return null;
            
            try {
                const result = await new Promise((resolve, reject) => {
                    geocoder.geocode(
                        { location: { lat, lng } },
                        (results, status) => {
                            if (status === 'OK' && results[0]) {
                                resolve(results[0]);
                            } else {
                                reject(new Error('Geocoding failed'));
                            }
                        }
                    );
                });
                
                // Parse the formatted address for better readability
                const address = result.formatted_address;
                
                // Try to get a cleaner address
                const addressComponents = result.address_components;
                let cleanAddress = '';
                
                // Build a clean address from components
                const streetNumber = addressComponents.find(c => c.types.includes('street_number'))?.long_name || '';
                const route = addressComponents.find(c => c.types.includes('route'))?.long_name || '';
                const locality = addressComponents.find(c => c.types.includes('administrative_area_level_4'))?.long_name || 
                                addressComponents.find(c => c.types.includes('locality'))?.long_name || '';
                const city = addressComponents.find(c => c.types.includes('administrative_area_level_2'))?.long_name || '';
                const province = addressComponents.find(c => c.types.includes('administrative_area_level_1'))?.long_name || '';
                
                if (streetNumber && route) {
                    cleanAddress = `${route} ${streetNumber}`;
                } else if (route) {
                    cleanAddress = route;
                } else if (locality) {
                    cleanAddress = locality;
                }
                
                if (locality && cleanAddress !== locality) {
                    cleanAddress += `, ${locality}`;
                }
                
                if (city && !cleanAddress.includes(city)) {
                    cleanAddress += `, ${city}`;
                }
                
                return cleanAddress || address;
                
            } catch (error) {
                console.log('Google Geocoding error:', error);
                return null;
            }
        }
        
        // Toggle location map display
        function toggleLocationMap() {
            const mapContainer = document.getElementById('locationMapContainer');
            const showMapBtn = document.getElementById('showMapBtn');
            
            if (mapContainer.classList.contains('hidden')) {
                // Show map
                mapContainer.classList.remove('hidden');
                showMapBtn.textContent = '🔼 Sembunyikan Peta';
                
                // Initialize map if not already done
                if (!locationMap) {
                    initializeLocationMap();
                }
            } else {
                // Hide map
                mapContainer.classList.add('hidden');
                showMapBtn.textContent = '📍 Lihat Peta';
            }
        }
        
        // Initialize location map
        function initializeLocationMap() {
            if (!googleMapsLoaded) {
                showNotification('Google Maps belum dimuat', 'error');
                return;
            }
            
            const mapElement = document.getElementById('locationMap');
            const accuracyElement = document.getElementById('mapAccuracy');
            
            // Default to Jakarta if no position available
            const defaultPosition = { lat: -6.2088, lng: 106.8456 };
            const initialPosition = currentMapPosition || defaultPosition;
            
            // Create map
            locationMap = new google.maps.Map(mapElement, {
                zoom: currentMapPosition ? 16 : 11,
                center: initialPosition,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                mapTypeControl: true,
                fullscreenControl: true,
                zoomControl: true
            });
            
            // Add marker
            currentLocationMarker = new google.maps.Marker({
                position: initialPosition,
                map: locationMap,
                draggable: true,
                title: 'Lokasi Kerja',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="16" cy="16" r="8" fill="#3B82F6" stroke="white" stroke-width="2"/>
                            <circle cx="16" cy="16" r="3" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 16)
                }
            });
            
            // Update accuracy display
            if (currentMapPosition && currentMapPosition.accuracy) {
                accuracyElement.textContent = `Akurasi: ${Math.round(currentMapPosition.accuracy)}m`;
            }
            
            // Add click listener to map
            locationMap.addListener('click', (event) => {
                const position = event.latLng;
                currentLocationMarker.setPosition(position);
                currentMapPosition = {
                    lat: position.lat(),
                    lng: position.lng()
                };
                
                // Update address
                updateAddressFromMapPosition(position.lat(), position.lng(), 'location');
            });
            
            // Add drag listener to marker
            currentLocationMarker.addListener('dragend', (event) => {
                const position = event.latLng;
                currentMapPosition = {
                    lat: position.lat(),
                    lng: position.lng()
                };
                
                // Update address
                updateAddressFromMapPosition(position.lat(), position.lng(), 'location');
            });
            
            showNotification('🗺️ Peta Google Maps siap! Klik atau drag marker untuk memilih lokasi', 'success');
        }
        
        // Update address from map position
        async function updateAddressFromMapPosition(lat, lng, inputType) {
            const address = await getAddressFromGoogleMaps(lat, lng);
            if (address) {
                const inputElement = document.getElementById(inputType);
                inputElement.value = address;
                showNotification('📍 Alamat diperbarui dari peta', 'success');
            }
        }
        
        // Confirm map location
        function confirmMapLocation() {
            if (currentMapPosition) {
                const locationInput = document.getElementById('location');
                if (!locationInput.value.trim()) {
                    updateAddressFromMapPosition(currentMapPosition.lat, currentMapPosition.lng, 'location');
                }
                toggleLocationMap();
                showNotification('✅ Lokasi dari peta dikonfirmasi!', 'success');
            } else {
                showNotification('Pilih lokasi di peta terlebih dahulu', 'error');
            }
        }
        
        // Post location functions
        async function getPostLocationWithGoogleMaps() {
            if (!googleMapsLoaded) {
                showNotification('⏳ Google Maps sedang dimuat...', 'info');
                setTimeout(() => getPostLocationWithGoogleMaps(), 2000);
                return;
            }
            
            const locationInput = document.getElementById('postLocation');
            const button = event.target;
            
            button.innerHTML = '⏳ Mengambil...';
            button.disabled = true;
            
            if (!navigator.geolocation) {
                showNotification('GPS tidak tersedia. Input manual tersedia.', 'info');
                button.innerHTML = '🗺️ Ambil Lokasi';
                button.disabled = false;
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                const address = await getAddressFromGoogleMaps(lat, lon);
                
                if (address) {
                    locationInput.value = address;
                    showNotification(`🗺️ Lokasi Google Maps berhasil! Akurasi ${Math.round(accuracy)}m`, 'success');
                    postMapPosition = { lat, lng: lon, accuracy };
                } else {
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                    postMapPosition = { lat, lng: lon, accuracy };
                }
                
            } catch (error) {
                console.error('Post location error:', error);
                showNotification('GPS gagal. Silakan input lokasi manual.', 'info');
            }
            
            button.innerHTML = '🗺️ Ambil Lokasi';
            button.disabled = false;
        }
        
        function togglePostLocationMap() {
            const mapContainer = document.getElementById('postLocationMapContainer');
            const button = event.target;
            
            if (mapContainer.classList.contains('hidden')) {
                mapContainer.classList.remove('hidden');
                button.textContent = '🔼 Sembunyikan Peta';
                
                if (!postLocationMap) {
                    initializePostLocationMap();
                }
            } else {
                mapContainer.classList.add('hidden');
                button.textContent = '📍 Lihat Peta';
            }
        }
        
        function initializePostLocationMap() {
            if (!googleMapsLoaded) {
                showNotification('Google Maps belum dimuat', 'error');
                return;
            }
            
            const mapElement = document.getElementById('postLocationMap');
            const accuracyElement = document.getElementById('postMapAccuracy');
            
            const defaultPosition = { lat: -6.2088, lng: 106.8456 };
            const initialPosition = postMapPosition || defaultPosition;
            
            postLocationMap = new google.maps.Map(mapElement, {
                zoom: postMapPosition ? 16 : 11,
                center: initialPosition,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                mapTypeControl: true,
                fullscreenControl: true,
                zoomControl: true
            });
            
            postLocationMarker = new google.maps.Marker({
                position: initialPosition,
                map: postLocationMap,
                draggable: true,
                title: 'Lokasi Postingan',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="16" cy="16" r="8" fill="#10B981" stroke="white" stroke-width="2"/>
                            <circle cx="16" cy="16" r="3" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 16)
                }
            });
            
            if (postMapPosition && postMapPosition.accuracy) {
                accuracyElement.textContent = `Akurasi: ${Math.round(postMapPosition.accuracy)}m`;
            }
            
            postLocationMap.addListener('click', (event) => {
                const position = event.latLng;
                postLocationMarker.setPosition(position);
                postMapPosition = {
                    lat: position.lat(),
                    lng: position.lng()
                };
                updateAddressFromMapPosition(position.lat(), position.lng(), 'postLocation');
            });
            
            postLocationMarker.addListener('dragend', (event) => {
                const position = event.latLng;
                postMapPosition = {
                    lat: position.lat(),
                    lng: position.lng()
                };
                updateAddressFromMapPosition(position.lat(), position.lng(), 'postLocation');
            });
            
            showNotification('🗺️ Peta postingan siap! Klik atau drag marker untuk memilih lokasi', 'success');
        }
        
        function confirmPostMapLocation() {
            if (postMapPosition) {
                const locationInput = document.getElementById('postLocation');
                if (!locationInput.value.trim()) {
                    updateAddressFromMapPosition(postMapPosition.lat, postMapPosition.lng, 'postLocation');
                }
                togglePostLocationMap();
                showNotification('✅ Lokasi postingan dari peta dikonfirmasi!', 'success');
            } else {
                showNotification('Pilih lokasi di peta terlebih dahulu', 'error');
            }
        }
        
        // LEGACY LOCATION FUNCTIONS (FALLBACK)
        async function getLocationAccurate() {
            const locationInput = document.getElementById('location');
            const button = document.getElementById('locationBtn');
            const statusDiv = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');
            
            // Show loading state
            button.innerHTML = '⏳ Mengambil...';
            button.disabled = true;
            statusDiv.className = 'location-status loading';
            statusDiv.classList.remove('hidden');
            statusText.textContent = 'Mengambil lokasi dengan GPS akurat...';
            
            if (!navigator.geolocation) {
                // Fallback to manual input
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS tidak tersedia - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = '❌ GPS tidak tersedia - Input manual aktif';
                
                button.innerHTML = '📍 Ambil Lokasi';
                button.disabled = false;
                
                showNotification('GPS tidak tersedia. Silakan input lokasi manual.', 'info');
                return;
            }
            
            // High accuracy GPS options
            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // 15 seconds timeout
                maximumAge: 30000 // 30 seconds cache
            };
            
            try {
                // Get current position with high accuracy
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                statusText.textContent = `📡 GPS ditemukan (akurasi: ${Math.round(accuracy)}m) - Mengambil alamat...`;
                
                // Try multiple geocoding services for better accuracy
                let address = await getAddressFromMultipleSources(lat, lon);
                
                if (address) {
                    locationInput.value = address;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `✅ Lokasi berhasil diambil (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification(`Lokasi berhasil diambil dengan akurasi ${Math.round(accuracy)} meter!`, 'success');
                } else {
                    // Fallback to coordinates
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    statusDiv.className = 'location-status success';
                    statusText.textContent = `✅ Koordinat GPS (akurasi: ${Math.round(accuracy)}m)`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                }
                
            } catch (error) {
                console.error('Geolocation error:', error);
                
                // Handle different error types
                let errorMessage = 'GPS tidak dapat diakses';
                if (error.code === 1) {
                    errorMessage = 'Izin GPS ditolak - Aktifkan di pengaturan browser';
                } else if (error.code === 2) {
                    errorMessage = 'Posisi tidak tersedia - Coba di area terbuka';
                } else if (error.code === 3) {
                    errorMessage = 'Timeout GPS - Sinyal lemah';
                }
                
                // Enable manual input
                locationInput.readOnly = false;
                locationInput.placeholder = 'GPS gagal - Masukkan lokasi manual';
                locationInput.focus();
                
                statusDiv.className = 'location-status error';
                statusText.textContent = `❌ ${errorMessage}`;
                
                showNotification(`${errorMessage}. Input manual diaktifkan.`, 'info');
            }
            
            // Reset button
            button.innerHTML = '📍 Ambil Lokasi';
            button.disabled = false;
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Get address from multiple geocoding sources
        async function getAddressFromMultipleSources(lat, lon) {
            const sources = [
                // Primary: BigDataCloud (free, no API key needed)
                {
                    url: `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=id`,
                    parser: (data) => {
                        if (data.locality && data.city) {
                            return `${data.locality}, ${data.city}, ${data.countryName}`;
                        } else if (data.city) {
                            return `${data.city}, ${data.countryName}`;
                        } else if (data.principalSubdivision) {
                            return `${data.principalSubdivision}, ${data.countryName}`;
                        }
                        return null;
                    }
                },
                // Secondary: OpenStreetMap Nominatim
                {
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=id`,
                    parser: (data) => {
                        if (data.display_name) {
                            // Parse and clean the address
                            const parts = data.display_name.split(',');
                            if (parts.length >= 3) {
                                return parts.slice(0, 3).join(', ').trim();
                            }
                            return data.display_name;
                        }
                        return null;
                    }
                }
            ];
            
            // Try each source
            for (const source of sources) {
                try {
                    const response = await fetch(source.url);
                    if (response.ok) {
                        const data = await response.json();
                        const address = source.parser(data);
                        if (address) {
                            return address;
                        }
                    }
                } catch (error) {
                    console.log(`Geocoding source failed:`, error);
                    continue;
                }
            }
            
            return null; // All sources failed
        }
        
        // Post location with same accuracy
        async function getPostLocationAccurate() {
            const locationInput = document.getElementById('postLocation');
            const button = event.target;
            
            // Show loading state
            button.innerHTML = '⏳ Mengambil...';
            button.disabled = true;
            
            if (!navigator.geolocation) {
                showNotification('GPS tidak tersedia. Input manual tersedia.', 'info');
                button.innerHTML = '📍 Ambil Lokasi';
                button.disabled = false;
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                let address = await getAddressFromMultipleSources(lat, lon);
                
                if (address) {
                    locationInput.value = address;
                    showNotification(`Lokasi berhasil diambil dengan akurasi ${Math.round(accuracy)} meter!`, 'success');
                } else {
                    locationInput.value = `Koordinat: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    showNotification('Lokasi diambil dalam bentuk koordinat GPS', 'info');
                }
                
            } catch (error) {
                console.error('Post location error:', error);
                showNotification('GPS gagal. Silakan input lokasi manual.', 'info');
            }
            
            // Reset button
            button.innerHTML = '📍 Ambil Lokasi';
            button.disabled = false;
        }
        
        // PROFESSIONAL CAMERA FUNCTIONS WITH FULL FUNCTIONALITY
        async function startCameraAdvanced() {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraStatusText');
            const settingsDiv = document.getElementById('cameraSettings');
            
            try {
                // Stop existing stream if any
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Enumerate available cameras
                await enumerateCameras();
                
                if (availableCameras.length === 0) {
                    throw new Error('Tidak ada kamera yang tersedia');
                }
                
                // Get quality constraints
                const qualityConstraints = getQualityConstraints();
                
                // Prefer back camera for field work
                let constraints = {
                    video: {
                        ...qualityConstraints,
                        facingMode: 'environment' // Back camera
                    }
                };
                
                // Try to get back camera first
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (backCameraError) {
                    console.log('Back camera not available, trying front camera:', backCameraError);
                    constraints.video.facingMode = 'user'; // Front camera
                    try {
                        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (frontCameraError) {
                        // Try with specific device ID
                        if (availableCameras.length > 0) {
                            constraints.video = {
                                ...qualityConstraints,
                                deviceId: { exact: availableCameras[0].deviceId }
                            };
                            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                        } else {
                            throw frontCameraError;
                        }
                    }
                }
                
                // Set video source
                video.srcObject = cameraStream;
                
                // Wait for video to load
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                // Show camera preview and controls
                video.classList.remove('hidden');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                cameraControls.classList.remove('hidden');
                statusDiv.classList.remove('hidden');
                settingsDiv.classList.remove('hidden');
                
                // Update status
                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();
                const label = track.label || 'Kamera';
                statusText.innerHTML = `🔴 ${label} - ${settings.width}x${settings.height}`;
                
                // Update camera selector
                updateCameraSelector();
                
                showNotification(`📷 Kamera live aktif! ${label} (${settings.width}x${settings.height})`, 'success');
                
            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Gagal mengakses kamera';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Izin kamera ditolak. Aktifkan di pengaturan browser.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Kamera tidak ditemukan di perangkat ini.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Kamera sedang digunakan aplikasi lain.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'Resolusi tidak didukung. Coba kualitas lebih rendah.';
                }
                
                showNotification(errorMessage, 'error');
                
                // Show error status
                statusDiv.classList.remove('hidden');
                statusText.innerHTML = '❌ Kamera Error';
            }
        }
        
        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                console.log(`Found ${availableCameras.length} camera(s):`, availableCameras);
                
                // Populate camera selector
                const cameraSelect = document.getElementById('cameraSelect');
                cameraSelect.innerHTML = '';
                
                availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = camera.label || `Kamera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error enumerating cameras:', error);
                availableCameras = [];
            }
        }
        
        function getQualityConstraints() {
            const qualitySettings = {
                high: {
                    width: { ideal: 1920, max: 1920 },
                    height: { ideal: 1080, max: 1080 }
                },
                medium: {
                    width: { ideal: 1280, max: 1280 },
                    height: { ideal: 720, max: 720 }
                },
                low: {
                    width: { ideal: 640, max: 640 },
                    height: { ideal: 480, max: 480 }
                }
            };
            
            return qualitySettings[currentQuality] || qualitySettings.medium;
        }
        
        function updateCameraSelector() {
            if (!cameraStream) return;
            
            const track = cameraStream.getVideoTracks()[0];
            const settings = track.getSettings();
            const cameraSelect = document.getElementById('cameraSelect');
            
            // Find current camera in the list
            const currentCamera = availableCameras.find(camera => 
                camera.deviceId === settings.deviceId
            );
            
            if (currentCamera) {
                const index = availableCameras.indexOf(currentCamera);
                cameraSelect.value = index;
                currentCameraIndex = index;
            }
        }
        
        async function switchCamera() {
            if (availableCameras.length <= 1) {
                showNotification('Hanya ada satu kamera tersedia', 'info');
                return;
            }
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            await switchToCamera(currentCameraIndex);
        }
        
        async function switchToSelectedCamera() {
            const cameraSelect = document.getElementById('cameraSelect');
            const selectedIndex = parseInt(cameraSelect.value);
            await switchToCamera(selectedIndex);
        }
        
        async function switchToCamera(cameraIndex) {
            if (!availableCameras[cameraIndex]) return;
            
            const video = document.getElementById('cameraPreview');
            const statusText = document.getElementById('cameraStatusText');
            
            try {
                // Stop current stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Get quality constraints
                const qualityConstraints = getQualityConstraints();
                
                // Start new stream with selected camera
                const constraints = {
                    video: {
                        ...qualityConstraints,
                        deviceId: { exact: availableCameras[cameraIndex].deviceId }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                
                // Wait for video to load
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                // Update status
                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();
                const label = availableCameras[cameraIndex].label || `Kamera ${cameraIndex + 1}`;
                statusText.innerHTML = `🔴 ${label} - ${settings.width}x${settings.height}`;
                
                currentCameraIndex = cameraIndex;
                
                showNotification(`📷 Beralih ke ${label}`, 'success');
                
            } catch (error) {
                console.error('Error switching camera:', error);
                showNotification('Gagal beralih kamera', 'error');
            }
        }
        
        async function changeQuality() {
            const qualitySelect = document.getElementById('qualitySelect');
            currentQuality = qualitySelect.value;
            
            if (cameraStream) {
                // Restart camera with new quality
                await switchToCamera(currentCameraIndex);
                showNotification(`Kualitas diubah ke ${qualitySelect.options[qualitySelect.selectedIndex].text}`, 'success');
            }
        }
        
        function toggleCameraSettings() {
            const settingsDiv = document.getElementById('cameraSettings');
            const toggleBtn = document.getElementById('toggleSettingsBtn');
            
            settingsDiv.classList.toggle('hidden');
            
            if (settingsDiv.classList.contains('hidden')) {
                toggleBtn.textContent = '⚙️ Pengaturan Kamera';
            } else {
                toggleBtn.textContent = '🔼 Sembunyikan Pengaturan';
            }
        }
        
        function stopCameraAdvanced() {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            const settingsDiv = document.getElementById('cameraSettings');
            
            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Hide camera preview and controls
            video.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            cameraControls.classList.add('hidden');
            statusDiv.classList.add('hidden');
            settingsDiv.classList.add('hidden');
            
            showNotification('📷 Kamera ditutup', 'info');
        }
        
        function capturePhotoAdvanced() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const previewDiv = document.getElementById('photoPreview');
            const previewImg = document.getElementById('previewImage');
            const photoInfo = document.getElementById('photoInfo');
            const retakeBtn = document.getElementById('retakeBtn');
            const cameraControls = document.getElementById('cameraControls');
            const statusDiv = document.getElementById('cameraStatus');
            const settingsDiv = document.getElementById('cameraSettings');
            
            if (!video.videoWidth || !video.videoHeight) {
                showNotification('Kamera belum siap. Tunggu sebentar dan coba lagi.', 'error');
                return;
            }
            
            // Add capture animation effect
            video.style.filter = 'brightness(1.5)';
            setTimeout(() => {
                video.style.filter = 'none';
            }, 150);
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            // Get compression settings based on quality
            const compressionSettings = {
                high: { maxWidth: 1920, maxHeight: 1080, quality: 0.9 },
                medium: { maxWidth: 1280, maxHeight: 720, quality: 0.8 },
                low: { maxWidth: 800, maxHeight: 600, quality: 0.7 }
            };
            
            const settings = compressionSettings[currentQuality] || compressionSettings.medium;
            
            // Compress image for optimal performance
            let { width, height } = canvas;
            const originalWidth = width;
            const originalHeight = height;
            
            // Calculate new dimensions maintaining aspect ratio
            if (width > height) {
                if (width > settings.maxWidth) {
                    height = (height * settings.maxWidth) / width;
                    width = settings.maxWidth;
                }
            } else {
                if (height > settings.maxHeight) {
                    width = (width * settings.maxHeight) / height;
                    height = settings.maxHeight;
                }
            }
            
            // Create compressed canvas
            const compressedCanvas = document.createElement('canvas');
            const compressedContext = compressedCanvas.getContext('2d');
            compressedCanvas.width = width;
            compressedCanvas.height = height;
            
            // Draw compressed image with better quality
            compressedContext.imageSmoothingEnabled = true;
            compressedContext.imageSmoothingQuality = 'high';
            compressedContext.drawImage(canvas, 0, 0, width, height);
            
            // Convert to base64 with optimal compression
            capturedPhoto = compressedCanvas.toDataURL('image/jpeg', settings.quality);
            
            // Calculate file size estimate
            const fileSizeKB = Math.round((capturedPhoto.length * 0.75) / 1024);
            
            // Show preview with info
            previewImg.src = capturedPhoto;
            photoInfo.innerHTML = `📷 ${Math.round(width)}x${Math.round(height)}px • ${fileSizeKB}KB • ${currentQuality.toUpperCase()}`;
            previewDiv.classList.remove('hidden');
            
            // Hide camera, show retake button
            video.classList.add('hidden');
            retakeBtn.classList.remove('hidden');
            cameraControls.classList.add('hidden');
            statusDiv.classList.add('hidden');
            settingsDiv.classList.add('hidden');
            
            // Stop camera stream to save battery
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            showNotification(`📸 Foto berhasil diambil! ${Math.round(width)}x${Math.round(height)}px (${fileSizeKB}KB)`, 'success');
        }
        
        function retakePhotoAdvanced() {
            // Hide preview and retake button
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            
            // Show start camera button
            document.getElementById('startCameraBtn').classList.remove('hidden');
            
            // Clear captured photo
            capturedPhoto = null;
            
            // Reset photo info
            document.getElementById('photoInfo').innerHTML = '📷 Resolusi: Loading...';
            
            showNotification('🔄 Siap untuk foto ulang! Klik "Buka Kamera Live"', 'info');
        }
        
        async function submitReport() {
            const team = document.getElementById('team').value.trim();
            const shift = document.getElementById('shift').value.trim();
            const activeOfficers = document.getElementById('activeOfficers').value.trim();
            const inactiveOfficers = document.getElementById('inactiveOfficers').value.trim();
            const location = document.getElementById('location').value.trim();
            const description = document.getElementById('description').value.trim();
            const photo = capturedPhoto || '';
            
            // Validate required fields
            if (!team || !shift || !activeOfficers || !location || !description) {
                showNotification('Mohon lengkapi semua field wajib! (Petugas tidak aktif opsional)', 'error');
                return;
            }
            
            // Validate photo
            if (!photo) {
                const confirmSubmit = confirm('Tidak ada foto dokumentasi. Apakah Anda yakin ingin melanjutkan?');
                if (!confirmSubmit) {
                    return;
                }
            }
            
            const formData = {
                team: team,
                shift: shift,
                activeOfficers: activeOfficers,
                inactiveOfficers: inactiveOfficers,
                location: location,
                photo: photo,
                description: description,
                createdAt: serverTimestamp(),
                date: new Date().toISOString()
            };
            
            try {
                // Save report to Firebase
                const reportRef = await addDoc(collection(window.db, 'reports'), formData);
                
                // Create feed post
                const feedPost = {
                    author: activeOfficers.split(',')[0].trim(),
                    team: team,
                    content: `Laporan Kerja: ${description}`,
                    location: location,
                    photo: photo,
                    likes: 0,
                    comments: [],
                    type: 'report',
                    createdAt: serverTimestamp(),
                    date: new Date().toISOString()
                };
                
                await addDoc(collection(window.db, 'feed'), feedPost);
                
                // Reset form and cleanup
                resetReportForm();
                
                showNotification('✅ Laporan berhasil dikirim dan tersimpan di database!', 'success');
                
            } catch (error) {
                console.log('Error saving to Firebase:', error);
                // Fallback to localStorage
                const localData = {
                    id: Date.now(),
                    ...formData,
                    date: new Date().toISOString()
                };
                
                let localReports = JSON.parse(localStorage.getItem('ppsu_reports') || '[]');
                let localFeed = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                
                localReports.push(localData);
                localStorage.setItem('ppsu_reports', JSON.stringify(localReports));
                
                const localFeedPost = {
                    id: Date.now(),
                    author: activeOfficers.split(',')[0].trim(),
                    team: team,
                    content: `Laporan Kerja: ${description}`,
                    location: location,
                    photo: photo,
                    likes: 0,
                    comments: [],
                    type: 'report',
                    date: new Date().toISOString()
                };
                
                localFeed.unshift(localFeedPost);
                localStorage.setItem('ppsu_feed', JSON.stringify(localFeed));
                
                resetReportForm();
                showNotification('Laporan tersimpan lokal (offline mode)', 'info');
            }
        }
        
        function resetReportForm() {
            // Reset form
            document.getElementById('reportForm').reset();
            
            // Reset photo components
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('stopCameraBtn').classList.add('hidden');
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('cameraControls').classList.add('hidden');
            document.getElementById('cameraStatus').classList.add('hidden');
            document.getElementById('cameraSettings').classList.add('hidden');
            document.getElementById('locationStatus').classList.add('hidden');
            
            // Reset photo info
            document.getElementById('photoInfo').innerHTML = '📷 Resolusi: Loading...';
            
            // Reset settings button
            document.getElementById('toggleSettingsBtn').textContent = '⚙️ Pengaturan Kamera';
            
            // Clear captured photo
            capturedPhoto = null;
            
            // Stop any active camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Stop location watching if active
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        async function submitPost() {
            const author = document.getElementById('postAuthor').value.trim();
            const team = document.getElementById('postTeam').value;
            const content = document.getElementById('postContent').value.trim();
            const location = document.getElementById('postLocation').value.trim();
            
            // Validate required fields
            if (!author || !team || !content) {
                showNotification('Mohon lengkapi nama, tim, dan isi postingan!', 'error');
                return;
            }
            
            // Create new post
            const newPost = {
                author: author,
                team: team,
                content: content,
                location: location || '',
                photo: '',
                likes: 0,
                comments: [],
                type: 'post',
                createdAt: serverTimestamp(),
                date: new Date().toISOString()
            };
            
            try {
                // Save to Firebase
                await addDoc(collection(window.db, 'feed'), newPost);
                
                // Reset form
                document.getElementById('postForm').reset();
                
                // Show success notification
                showNotification('✅ Postingan berhasil dipublikasi ke database!', 'success');
                
            } catch (error) {
                console.log('Error saving post to Firebase:', error);
                // Fallback to localStorage
                const localPost = {
                    id: Date.now(),
                    ...newPost,
                    date: new Date().toISOString()
                };
                
                let localFeed = JSON.parse(localStorage.getItem('ppsu_feed') || '[]');
                localFeed.unshift(localPost);
                localStorage.setItem('ppsu_feed', JSON.stringify(localFeed));
                
                // Reset form
                document.getElementById('postForm').reset();
                
                showNotification('Postingan tersimpan lokal (offline mode)', 'info');
            }
        }
        
        function loadFeedPosts() {
            const container = document.getElementById('feedContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (feedPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-white/70 py-12">
                        <div class="text-6xl mb-4">📝</div>
                        <p class="text-xl">Belum ada postingan atau laporan</p>
                        <p>Buat postingan pertama Anda atau submit laporan untuk melihat feed aktivitas</p>
                    </div>
                `;
                return;
            }
            
            feedPosts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20 card-hover';
                
                // Add animation for new posts
                if (index === 0) {
                    postElement.classList.add('post-animation');
                }
                
                const postTypeIcon = post.type === 'report' ? '📋' : '📢';
                const postTypeLabel = post.type === 'report' ? 'Laporan Kerja' : 'Postingan';
                
                postElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">${post.author.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="text-white font-semibold">${post.author}</h4>
                                <span class="text-white/60 text-sm">• ${post.team}</span>
                                <span class="text-white/60 text-sm">• ${new Date(post.date).toLocaleString('id-ID')}</span>
                                <span class="bg-white/20 text-white/80 px-2 py-1 rounded text-xs flex items-center">
                                    ${postTypeIcon} ${postTypeLabel}
                                </span>
                            </div>
                            <p class="text-white/90 mb-3">${post.content}</p>
                            ${post.location ? `
                                <div class="text-white/70 text-sm mb-3 flex items-center">
                                    <span class="mr-1">📍</span>
                                    ${post.location}
                                </div>
                            ` : ''}
                            ${post.photo ? `<img src="${post.photo}" class="w-full max-w-md rounded-lg mb-4 cursor-pointer" onclick="viewPhoto('${post.photo}')">` : ''}
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4 text-white/70">
                                    <button onclick="likePost('${post.id}')" class="flex items-center space-x-1 hover:text-red-400 transition-colors">
                                        <span>❤️</span>
                                        <span>${post.likes}</span>
                                    </button>
                                    <button onclick="toggleComments('${post.id}')" class="flex items-center space-x-1 hover:text-blue-400 transition-colors">
                                        <span>💬</span>
                                        <span>${post.comments.length}</span>
                                    </button>
                                </div>
                                ${currentUser && currentUser.role === 'admin' ? `
                                    <button onclick="deleteFeedPost('${post.id}')" class="text-red-400 hover:text-red-300 transition-colors text-sm">
                                        🗑️ Hapus
                                    </button>
                                ` : ''}
                            </div>
                            <div id="comments-${post.id}" class="hidden mt-4 space-y-3">
                                <div class="space-y-2">
                                    ${post.comments.map(comment => `
                                        <div class="bg-white/5 rounded-lg p-3">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-white font-medium text-sm">${comment.author}</span>
                                                <span class="text-white/50 text-xs">${new Date(comment.date).toLocaleString('id-ID')}</span>
                                            </div>
                                            <p class="text-white/80 text-sm">${comment.text}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="comment-input-${post.id}" placeholder="Tulis komentar..." class="flex-1 px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <button onclick="addComment('${post.id}')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg text-sm hover:shadow-lg transition-all">
                                        Kirim
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(postElement);
            });
        }
        
        async function likePost(postId) {
            try {
                const post = feedPosts.find(p => p.id === postId);
                if (post) {
                    // Update locally first for immediate feedback
                    post.likes++;
                    
                    // Update in Firebase
                    const postRef = doc(window.db, 'feed', postId);
                    await updateDoc(postRef, { likes: post.likes });
                    
                    showNotification('Post disukai!', 'success');
                }
            } catch (error) {
                console.log('Error updating likes:', error);
                showNotification('Gagal menyukai post', 'error');
            }
        }
        
        function toggleComments(postId) {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.classList.toggle('hidden');
        }
        
        async function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const commentText = input.value.trim();
            
            if (!commentText) return;
            
            try {
                const post = feedPosts.find(p => p.id === postId);
                if (post) {
                    const newComment = {
                        id: Date.now(),
                        author: 'Petugas',
                        text: commentText,
                        date: new Date().toISOString()
                    };
                    
                    // Update locally first
                    post.comments.push(newComment);
                    
                    // Update in Firebase
                    const postRef = doc(window.db, 'feed', postId);
                    await updateDoc(postRef, { comments: post.comments });
                    
                    input.value = '';
                    showNotification('Komentar ditambahkan!', 'success');
                }
            } catch (error) {
                console.log('Error adding comment:', error);
                showNotification('Gagal menambahkan komentar', 'error');
            }
        }
        
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === 'elfida' && password === 'Pis212bar@') {
                currentUser = { username: 'elfida', role: 'admin' };
                showPage('admin');
                showNotification('Login berhasil!', 'success');
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            showPage('home');
            showNotification('Logout berhasil!', 'success');
        }
        
        function updateAdminStats() {
            const today = new Date().toDateString();
            const todayReports = reports.filter(r => new Date(r.date).toDateString() === today);
            
            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('todayReports').textContent = todayReports.length;
            document.getElementById('totalPosts').textContent = feedPosts.length;
            
            const activeOfficers = new Set();
            reports.forEach(r => {
                if (r.activeOfficers) {
                    r.activeOfficers.split(',').forEach(officer => {
                        activeOfficers.add(officer.trim());
                    });
                }
            });
            document.getElementById('activeOfficersCount').textContent = activeOfficers.size;
        }
        
        function updateReportsTable() {
            const tbody = document.getElementById('reportsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4">${new Date(report.date).toLocaleDateString('id-ID')}</td>
                    <td class="py-3 px-4">${report.team}</td>
                    <td class="py-3 px-4">${report.shift}</td>
                    <td class="py-3 px-4">${report.activeOfficers}</td>
                    <td class="py-3 px-4">${report.location.substring(0, 30)}...</td>
                    <td class="py-3 px-4">
                        ${report.photo ? `<img src="${report.photo}" class="w-12 h-12 object-cover rounded cursor-pointer" onclick="viewPhoto('${report.photo}')" title="Klik untuk melihat foto">` : '<span class="text-white/50">Tidak ada foto</span>'}
                    </td>
                    <td class="py-3 px-4">
                        <span class="bg-green-500 text-white px-2 py-1 rounded text-sm">Selesai</span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editReport('${report.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✏️ Edit
                            </button>
                            <button onclick="deleteReport('${report.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                🗑️ Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateFeedTable() {
            const tbody = document.getElementById('feedTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            feedPosts.forEach(post => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4">${new Date(post.date).toLocaleDateString('id-ID')}</td>
                    <td class="py-3 px-4">${post.author}</td>
                    <td class="py-3 px-4">${post.team}</td>
                    <td class="py-3 px-4">${post.content.substring(0, 50)}...</td>
                    <td class="py-3 px-4">
                        <span class="bg-${post.type === 'report' ? 'blue' : 'purple'}-500 text-white px-2 py-1 rounded text-sm">
                            ${post.type === 'report' ? 'Laporan' : 'Postingan'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editPost('${post.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✏️ Edit
                            </button>
                            <button onclick="deleteFeedPost('${post.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                🗑️ Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function editReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            document.getElementById('editReportId').value = reportId;
            document.getElementById('editTeam').value = report.team;
            document.getElementById('editShift').value = report.shift;
            document.getElementById('editActiveOfficers').value = report.activeOfficers;
            document.getElementById('editInactiveOfficers').value = report.inactiveOfficers || '';
            document.getElementById('editLocation').value = report.location;
            document.getElementById('editDescription').value = report.description;
            
            document.getElementById('editReportModal').classList.remove('hidden');
        }
        
        function editPost(postId) {
            const post = feedPosts.find(p => p.id === postId);
            if (!post) return;
            
            document.getElementById('editPostId').value = postId;
            document.getElementById('editPostAuthor').value = post.author;
            document.getElementById('editPostTeam').value = post.team;
            document.getElementById('editPostContent').value = post.content;
            document.getElementById('editPostLocation').value = post.location || '';
            
            document.getElementById('editPostModal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('editReportModal').classList.add('hidden');
        }
        
        function closeEditPostModal() {
            document.getElementById('editPostModal').classList.add('hidden');
        }
        
        async function saveReportEdit() {
            const reportId = document.getElementById('editReportId').value;
            const team = document.getElementById('editTeam').value.trim();
            const shift = document.getElementById('editShift').value.trim();
            const activeOfficers = document.getElementById('editActiveOfficers').value.trim();
            const inactiveOfficers = document.getElementById('editInactiveOfficers').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            
            if (!team || !shift || !activeOfficers || !location || !description) {
                showNotification('Mohon lengkapi semua field wajib!', 'error');
                return;
            }
            
            const updatedData = {
                team: team,
                shift: shift,
                activeOfficers: activeOfficers,
                inactiveOfficers: inactiveOfficers,
                location: location,
                description: description
            };
            
            try {
                await updateDoc(doc(window.db, 'reports', reportId), updatedData);
                closeEditModal();
                showNotification('Laporan berhasil diperbarui!', 'success');
            } catch (error) {
                console.log('Error updating report:', error);
                showNotification('Gagal memperbarui laporan', 'error');
            }
        }
        
        async function savePostEdit() {
            const postId = document.getElementById('editPostId').value;
            const author = document.getElementById('editPostAuthor').value.trim();
            const team = document.getElementById('editPostTeam').value.trim();
            const content = document.getElementById('editPostContent').value.trim();
            const location = document.getElementById('editPostLocation').value.trim();
            
            if (!author || !team || !content) {
                showNotification('Mohon lengkapi nama, tim, dan konten!', 'error');
                return;
            }
            
            const updatedData = {
                author: author,
                team: team,
                content: content,
                location: location
            };
            
            try {
                await updateDoc(doc(window.db, 'feed', postId), updatedData);
                closeEditPostModal();
                showNotification('Postingan berhasil diperbarui!', 'success');
            } catch (error) {
                console.log('Error updating post:', error);
                showNotification('Gagal memperbarui postingan', 'error');
            }
        }
        
        async function deleteReport(reportId) {
            if (!confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                return;
            }
            
            try {
                // Delete from Firebase
                await deleteDoc(doc(window.db, 'reports', reportId));
                
                // Also delete related feed post
                const relatedFeedPost = feedPosts.find(post => post.type === 'report' && post.content.includes('Laporan Kerja'));
                if (relatedFeedPost && relatedFeedPost.id) {
                    try {
                        await deleteDoc(doc(window.db, 'feed', relatedFeedPost.id));
                    } catch (error) {
                        console.log('Error deleting related feed post:', error);
                    }
                }
                
                showNotification('Laporan berhasil dihapus dari database!', 'success');
                
            } catch (error) {
                console.log('Error deleting from Firebase:', error);
                showNotification('Gagal menghapus dari database. Coba lagi.', 'error');
            }
        }
        
        async function deleteFeedPost(postId) {
            if (!confirm('Apakah Anda yakin ingin menghapus postingan ini?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(window.db, 'feed', postId));
                showNotification('Postingan berhasil dihapus!', 'success');
            } catch (error) {
                console.log('Error deleting feed post:', error);
                showNotification('Gagal menghapus postingan. Coba lagi.', 'error');
            }
        }
        
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(reports.map(r => ({
                'Tanggal': new Date(r.date).toLocaleDateString('id-ID'),
                'Tim': r.team,
                'Shift': r.shift,
                'Petugas Aktif': r.activeOfficers,
                'Petugas Tidak Aktif': r.inactiveOfficers,
                'Lokasi': r.location,
                'Deskripsi': r.description
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Kerja');
            XLSX.writeFile(wb, `Laporan_PPSU_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('File Excel berhasil diunduh!', 'success');
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Laporan Kerja PPSU-Pisbar-App', 20, 20);
            
            let y = 40;
            reports.forEach((report, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${new Date(report.date).toLocaleDateString('id-ID')} - ${report.team}`, 20, y);
                y += 10;
                doc.text(`   Shift: ${report.shift}`, 20, y);
                y += 10;
                doc.text(`   Petugas: ${report.activeOfficers}`, 20, y);
                y += 10;
                doc.text(`   Lokasi: ${report.location.substring(0, 60)}`, 20, y);
                y += 15;
            });
            
            doc.save(`Laporan_PPSU_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('File PDF berhasil diunduh!', 'success');
        }
        
        function viewPhoto(photoSrc) {
            // Create modal to view photo
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
            modal.onclick = () => modal.remove();
            
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full">
                    <img src="${photoSrc}" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
                    <div class="text-center mt-4">
                        <button onclick="this.parentElement.parentElement.remove()" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';
            
            notification.className = `notification ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg text-sm`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Cleanup function when page unloads
        window.addEventListener('beforeunload', function() {
            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            // Stop location watching
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            // Cleanup Firebase listeners
            if (reportsListener) reportsListener();
            if (feedListener) feedListener();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975505ac751efceb',t:'MTc1NjIyOTA2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
